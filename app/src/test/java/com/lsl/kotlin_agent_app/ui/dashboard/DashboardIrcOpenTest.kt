package com.lsl.kotlin_agent_app.ui.dashboard

import androidx.lifecycle.ViewModelProvider
import androidx.navigation.fragment.NavHostFragment
import androidx.recyclerview.widget.RecyclerView
import com.google.android.material.bottomnavigation.BottomNavigationView
import com.lsl.kotlin_agent_app.MainActivity
import com.lsl.kotlin_agent_app.R
import com.lsl.kotlin_agent_app.agent.AgentsDirEntryType
import com.lsl.kotlin_agent_app.agent.AgentsWorkspace
import com.lsl.kotlin_agent_app.ui.irc.IrcActivity
import org.junit.Assert.assertEquals
import org.junit.Assert.assertNotNull
import org.junit.Assert.assertTrue
import org.junit.Test
import org.junit.runner.RunWith
import org.robolectric.Robolectric
import org.robolectric.RobolectricTestRunner
import org.robolectric.annotation.Config
import org.robolectric.shadows.ShadowLooper
import org.robolectric.Shadows.shadowOf

@RunWith(RobolectricTestRunner::class)
@Config(sdk = [34])
class DashboardIrcOpenTest {

    @Test
    fun clickIrcDir_opensIrcActivity() {
        val activity = Robolectric.buildActivity(MainActivity::class.java).setup().get()
        val bottomNav = activity.findViewById<BottomNavigationView>(R.id.nav_view)
        assertNotNull(bottomNav)

        bottomNav.selectedItemId = R.id.navigation_dashboard
        ShadowLooper.runUiThreadTasksIncludingDelayedTasks()

        val navHost =
            activity.supportFragmentManager.findFragmentById(R.id.nav_host_fragment_activity_main) as NavHostFragment
        val dashboard =
            (
                navHost.childFragmentManager.primaryNavigationFragment
                    ?: navHost.childFragmentManager.fragments.firstOrNull { it is DashboardFragment }
            ) as DashboardFragment
        ShadowLooper.runUiThreadTasksIncludingDelayedTasks()
        assertNotNull(dashboard.view)

        val ws = AgentsWorkspace(activity)
        ws.ensureInitialized()
        ws.mkdir(".agents/workspace/irc")

        val vm = ViewModelProvider(dashboard, FilesViewModel.Factory(activity)).get(FilesViewModel::class.java)
        vm.goTo(".agents/workspace")

        val deadlineMs = System.currentTimeMillis() + 2_000
        while (
            vm.state.value?.entries?.any { it.type == AgentsDirEntryType.Dir && it.name == "irc" } != true &&
                System.currentTimeMillis() < deadlineMs
        ) {
            ShadowLooper.runUiThreadTasksIncludingDelayedTasks()
            Thread.sleep(10)
        }
        assertTrue(vm.state.value?.entries?.any { it.name == "irc" } == true)

        val recycler = dashboard.requireView().findViewById<RecyclerView>(R.id.recycler_entries)
        assertNotNull(recycler)
        recycler.measure(
            ViewMeasureSpec.makeMeasureSpec(1080, ViewMeasureSpec.EXACTLY),
            ViewMeasureSpec.makeMeasureSpec(1920, ViewMeasureSpec.AT_MOST),
        )
        recycler.layout(0, 0, 1080, 1920)

        val adapter = recycler.adapter as? FilesEntryAdapter
        assertNotNull(adapter)
        val deadlineAdapterMs = System.currentTimeMillis() + 2_000
        var pos = -1
        while (pos < 0 && System.currentTimeMillis() < deadlineAdapterMs) {
            ShadowLooper.runUiThreadTasksIncludingDelayedTasks()
            pos = adapter!!.currentList.indexOfFirst { it.name == "irc" && it.type == AgentsDirEntryType.Dir }
            if (pos < 0) Thread.sleep(10)
        }
        assertTrue("irc entry should be listed", pos >= 0)

        recycler.scrollToPosition(pos)
        ShadowLooper.runUiThreadTasksIncludingDelayedTasks()
        recycler.layout(0, 0, 1080, 1920)

        val vh = recycler.findViewHolderForAdapterPosition(pos)
        assertNotNull(vh)
        vh!!.itemView.performClick()
        ShadowLooper.runUiThreadTasksIncludingDelayedTasks()

        val started = shadowOf(activity).nextStartedActivity
        assertNotNull(started)
        assertEquals(IrcActivity::class.java.name, started!!.component?.className)
    }

    private object ViewMeasureSpec {
        const val EXACTLY = android.view.View.MeasureSpec.EXACTLY
        const val AT_MOST = android.view.View.MeasureSpec.AT_MOST

        fun makeMeasureSpec(size: Int, mode: Int): Int = android.view.View.MeasureSpec.makeMeasureSpec(size, mode)
    }
}

