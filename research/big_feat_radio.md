# PRD-0031: Radio å½•åˆ¶ã€è½¬å½•ç¿»è¯‘ä¸å®æ—¶ç¿»è¯‘ç®¡çº¿

æ—¥æœŸï¼š2026-02-19
ä½œè€…ï¼šæŸ æª¬å” + Kiro
å·¥ç¨‹ï¼škotlin-agent-appï¼ˆAndroidï¼‰
çŠ¶æ€ï¼šè‰æ¡ˆï¼ˆDraftï¼‰
å…³è”ï¼šPRD-0030-radio-player.mdã€v38 Radio æ¨¡å—æ€»è§ˆ

---

## 0. æ–‡æ¡£ç‰ˆæœ¬

| ç‰ˆæœ¬ | æ—¥æœŸ | å˜æ›´ |
|------|------|------|
| 0.1 | 2026-02-19 | åˆç¨¿ï¼Œè¦†ç›–å½•åˆ¶/è½¬å½•ç¿»è¯‘/è¯­è¨€å­¦ä¹ /å®æ—¶ç®¡çº¿å››å¤§å— |

---

## 1. èƒŒæ™¯ä¸åŠ¨æœº

Radio æ¨¡å—ï¼ˆv38ï¼‰å·²å®ç°"ç”µå°å³æ–‡ä»¶"çš„æµè§ˆä¸æ’­æ”¾é—­ç¯ã€‚ç”¨æˆ·ï¼ˆæŸ æª¬å”ï¼‰çš„ä¸‹ä¸€æ­¥éœ€æ±‚æ˜¯ï¼š

- èƒ½å½•åˆ¶ç”µå°èŠ‚ç›®ï¼Œç¦»çº¿å›å¬
- èƒ½æŠŠå½•éŸ³è½¬å½•æˆæ–‡å­—ï¼Œå¹¶ç¿»è¯‘æˆç›®æ ‡è¯­è¨€ï¼Œç”¨äºè¯­è¨€å­¦ä¹ 
- èƒ½å®æ—¶æ”¶å¬ç”µå°çš„åŒæ—¶ï¼Œè·å¾—ç¿»è¯‘å­—å¹•ç”šè‡³è¯‘æ–‡è¯­éŸ³
- ä»¥ä¸Šæ‰€æœ‰äº§ç‰©éƒ½ä»¥æ–‡ä»¶å½¢å¼è½ç›˜ï¼Œéµå¾ª "Everything is FileSystem" åŸåˆ™

æœ¬ PRD è¦†ç›–ä»å½•åˆ¶åˆ°å®æ—¶ç¿»è¯‘ç®¡çº¿çš„å®Œæ•´é“¾è·¯ï¼Œåˆ†å…­æœŸäº¤ä»˜ã€‚

---

## 2. æ ¸å¿ƒè®¾è®¡å†³ç­–ï¼ˆå·²ç¡®è®¤ï¼‰

| å†³ç­–ç‚¹ | ç»“è®º | ç†ç”± |
|--------|------|------|
| å½•åˆ¶æ–¹æ¡ˆ | Media3 å¼€ç‹¬ç«‹ Player å®ä¾‹ï¼Œè§£ç ä¸º PCM åç¼–ç å†™ç›˜ | æ ¼å¼ç»Ÿä¸€ï¼ˆç»Ÿä¸€è¾“å‡º MP3/AACï¼‰ï¼Œä¸‹æ¸¸ ASR å°‘è¸©å‘ |
| å¹¶å‘å½•åˆ¶ä¸Šé™ | æœ€å¤š 2 è·¯ | è§£ç +ç¼–ç å¼€é”€ä¸å°ï¼Œ2 è·¯æ˜¯åŠ¡å®ä¸Šé™ï¼›UI/CLI éœ€æ˜ç¡®å‘ŠçŸ¥ |
| ASR åç«¯ | ä»…äº‘ç«¯ï¼ˆOpenAI Whisper API ä¸ºé¦–é€‰ï¼Œå¯æ‰©å±•å…¶ä»–äº‘ç«¯ï¼‰ | ä¸è€ƒè™‘æœ¬åœ°æ¨¡å‹ï¼Œé™ä½å¤æ‚åº¦ |
| è¯‘æ–‡æ’­æ”¾æ¨¡å¼ | åŒæ¨¡å¼ï¼šâ‘  ä»…è¯‘æ–‡è¯­éŸ³ â‘¡ åŸå£°ï¼ˆé™éŸ³é‡ï¼‰+ è¯‘æ–‡äº¤æ›¿ | ç”¨æˆ·å¯æŒ‰åœºæ™¯åˆ‡æ¢ |
| å®æ—¶ç®¡çº¿å»¶è¿Ÿ | å¯æ¥å— â‰¤10 ç§’ | buffer 5-10 ç§’æ”’ä¸€æ®µå†é€ ASRï¼Œä½“éªŒå¯æ¥å— |
| è½ç›˜ç¼–ç æ ¼å¼ | ç»Ÿä¸€ AACï¼ˆ.m4aï¼‰ï¼Œ128kbps | Android MediaCodec åŸç”Ÿæ”¯æŒç¼–ç ï¼Œä½“ç§¯é€‚ä¸­ï¼ŒASR å…¼å®¹å¥½ |

---

## 3. èƒ½åŠ›åˆ†å±‚æ€»è§ˆ

```
Layer 4:  å®æ—¶ç¿»è¯‘ç®¡çº¿ï¼ˆLive Translation Pipelineï¼‰     â€” v44, v45
Layer 3:  è¯­è¨€å­¦ä¹ äº¤äº’ï¼ˆLanguage Learning Agentï¼‰        â€” v42
Layer 2:  ç¦»çº¿è½¬å½• / ç¿»è¯‘ï¼ˆTranscript & Translationï¼‰    â€” v40, v41
Layer 1:  åå°å½•åˆ¶ï¼ˆRadio Recordingï¼‰                    â€” v39
Layer 0:  ç°æœ‰ Radio æ¨¡å—ï¼ˆå·²å®Œæˆï¼Œv38ï¼‰
```

---

## 4. Layer 1: åå°å½•åˆ¶ï¼ˆv39ï¼‰

### 4.1 ç”¨æˆ·æ•…äº‹

- ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘æƒ³åœ¨ UI ä¸Šç‚¹å‡»"å½•åˆ¶"æŒ‰é’®ï¼Œå¼€å§‹å½•åˆ¶å½“å‰æ­£åœ¨æ’­æ”¾çš„ç”µå°ï¼ˆæˆ–æŒ‡å®šç”µå°ï¼‰
- ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘æƒ³é€šè¿‡ Agent CLI å‘èµ·å½•åˆ¶ï¼ŒåŒ…æ‹¬å®šæ—¶å½•åˆ¶
- ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘æƒ³åŒæ—¶å½•åˆ¶æœ€å¤š 2 ä¸ªç”µå°
- å½•åˆ¶è¿‡ç¨‹ä¸­æˆ‘å¯ä»¥åˆ‡é¡µç­¾ã€é”å±ã€åå°ï¼Œå½•åˆ¶ä¸ä¸­æ–­
- å½•åˆ¶äº§ç‰©æŒ‰ 10 åˆ†é’Ÿåˆ‡ç‰‡ï¼Œè½ç›˜åˆ°ç‹¬ç«‹ç›®å½•

### 4.2 è½ç›˜ç»“æ„

```
.agents/workspace/radio_recordings/
  _STATUS.md                              # å½•åˆ¶æ¨¡å—å…¨å±€çŠ¶æ€
  .recordings.index.json                  # å…¨å±€å½•åˆ¶ä¼šè¯ç´¢å¼•
  {session_id}/                           # å•æ¬¡å½•åˆ¶ä¼šè¯ç›®å½•
    _meta.json                            # å½•åˆ¶å…ƒä¿¡æ¯
    _STATUS.md                            # æœ¬æ¬¡å½•åˆ¶çŠ¶æ€ï¼ˆå¯è§£é‡Šå¤±è´¥ï¼‰
    chunk_001.m4a                         # 10min åˆ‡ç‰‡ï¼ˆAAC, 128kbpsï¼‰
    chunk_002.m4a
    ...
```

### 4.3 `_meta.json` Schema

```json
{
  "schema": "kotlin-agent-app/radio-recording-meta@v1",
  "sessionId": "rec_20260219_140000_a1b2c3",
  "sourceRadio": {
    "path": "workspace/radios/JP__Japan/NHK_World__xxxx.radio",
    "name": "NHK World",
    "country": "Japan",
    "streamUrl": "https://..."
  },
  "schedule": {
    "type": "immediate | scheduled",
    "startAt": "2026-02-19T14:00:00+08:00",
    "endAt": "2026-02-19T16:00:00+08:00",
    "requestedDurationMin": 120
  },
  "chunkDurationMin": 10,
  "outputFormat": "aac_128kbps",
  "state": "pending | recording | completed | failed | cancelled",
  "createdAt": "2026-02-19T13:58:00+08:00",
  "updatedAt": "2026-02-19T16:00:05+08:00",
  "chunks": [
    {
      "file": "chunk_001.m4a",
      "index": 1,
      "startAt": "2026-02-19T14:00:00+08:00",
      "endAt": "2026-02-19T14:10:00+08:00",
      "durationSec": 600,
      "sizeBytes": 960000
    }
  ],
  "error": null,
  "transcriptRequest": null
}
```

### 4.4 `.recordings.index.json` Schema

```json
{
  "schema": "kotlin-agent-app/radio-recordings-index@v1",
  "generatedAtSec": 1739952000,
  "sessions": [
    {
      "sessionId": "rec_20260219_140000_a1b2c3",
      "dir": "rec_20260219_140000_a1b2c3",
      "stationName": "NHK World",
      "state": "recording",
      "startAt": "2026-02-19T14:00:00+08:00",
      "chunksCount": 5
    }
  ]
}
```

### 4.5 å½•åˆ¶å¼•æ“è®¾è®¡

```
RadioRecordingService (Foreground Service)
  â”œâ”€â”€ RecordingSession (æœ€å¤š 2 ä¸ªå¹¶å‘)
  â”‚     â”œâ”€â”€ Media3 ExoPlayer å®ä¾‹ï¼ˆç‹¬ç«‹äºæ’­æ”¾ç”¨çš„ Playerï¼‰
  â”‚     â”œâ”€â”€ è‡ªå®šä¹‰ AudioSink â†’ PCM æµ
  â”‚     â”œâ”€â”€ AudioEncoder (MediaCodec, AAC 128kbps)
  â”‚     â””â”€â”€ ChunkWriter (æ¯ 10min åˆ‡ä¸€ä¸ª .m4a æ–‡ä»¶)
  â””â”€â”€ é€šçŸ¥æ ï¼šæ˜¾ç¤º"æ­£åœ¨å½•åˆ¶ N ä¸ªç”µå°"+ å„è‡ªè¿›åº¦
```

å…³é”®å®ç°ç‚¹ï¼š

- æ¯ä¸ª `RecordingSession` æŒæœ‰ç‹¬ç«‹çš„ `ExoPlayer` å®ä¾‹ï¼Œä»…åšè§£ç ï¼Œä¸èµ°éŸ³é¢‘è¾“å‡ºï¼ˆ`AudioSink` é‡å®šå‘åˆ° PCM bufferï¼‰
- `ChunkWriter` è´Ÿè´£æŒ‰æ—¶é—´åˆ‡ç‰‡ï¼šåˆ°è¾¾ 10min è¾¹ç•Œæ—¶ï¼Œå…³é—­å½“å‰ `.m4a`ï¼Œå¼€æ–°æ–‡ä»¶ï¼Œæ›´æ–° `_meta.json`
- å½•åˆ¶ç»“æŸï¼ˆåˆ°è¾¾ endAt / æ‰‹åŠ¨åœæ­¢ / æµæ–­å¼€ï¼‰æ—¶ï¼Œå†™å…¥æœ€ç»ˆçŠ¶æ€åˆ° `_meta.json` å’Œ `_STATUS.md`
- æµæ–­å¼€çš„é‡è¿ç­–ç•¥ï¼šæœ€å¤šé‡è¯• 3 æ¬¡ï¼Œé—´éš” 5s/15s/30sï¼Œè¶…è¿‡åˆ™æ ‡è®° `failed` å¹¶å†™å…¥ `_STATUS.md` è¯´æ˜åŸå› 

### 4.6 å®šæ—¶å½•åˆ¶

- Agent é€šè¿‡ CLI è®¾ç½® `schedule.type = "scheduled"`
- ä½¿ç”¨ `WorkManager` åšå®šæ—¶è§¦å‘ï¼ˆç²¾åº¦åœ¨åˆ†é’Ÿçº§ï¼Œå¯¹ç”µå°å½•åˆ¶è¶³å¤Ÿï¼‰
- è§¦å‘æ—¶å¯åŠ¨ `RadioRecordingService`ï¼Œåˆ›å»º `RecordingSession`
- è‹¥è§¦å‘æ—¶å·²æœ‰ 2 è·¯åœ¨å½•ï¼Œæ’é˜Ÿç­‰å¾…æˆ–è¿”å›é”™è¯¯ï¼ˆCLI å¯é…ç½®ç­–ç•¥ï¼‰

### 4.7 CLI æ‰©å±•

```
radio record start --in <.radio path> [--duration_min 120] [--chunk_min 10]
radio record start --in <.radio path> --start_at "2026-02-19T14:00" --end_at "2026-02-19T16:00"
radio record stop --session <sessionId>
radio record stop --all
radio record list
radio record status [--session <sessionId>]
```

`radio record start` çš„ resultï¼š

```json
{
  "session_id": "rec_20260219_140000_a1b2c3",
  "state": "recording",
  "station_name": "NHK World",
  "message": "Recording started, chunk duration: 10min"
}
```

å¹¶å‘è¶…é™æ—¶ï¼š

```json
{
  "error_code": "MaxConcurrentRecordings",
  "error_message": "Already recording 2 stations. Stop one before starting a new recording.",
  "active_sessions": ["rec_...", "rec_..."]
}
```

### 4.8 UI å…¥å£

- `.radio` æ–‡ä»¶è¯¦æƒ…é¡µ / é•¿æŒ‰èœå• â†’ "å½•åˆ¶æ­¤ç”µå°"
- æ­£åœ¨æ’­æ”¾çš„ç”µå° â†’ æ’­æ”¾å™¨æ§åˆ¶æ å¢åŠ "å½•åˆ¶"æŒ‰é’®
- `radio_recordings/` ç›®å½•åœ¨ Files ä¸­å¯æµè§ˆï¼Œç‚¹å‡»ä¼šè¯ç›®å½•å¯æŸ¥çœ‹åˆ‡ç‰‡åˆ—è¡¨å’ŒçŠ¶æ€
- é€šçŸ¥æ å¸¸é©»æ˜¾ç¤ºå½•åˆ¶çŠ¶æ€ï¼Œç‚¹å‡»è·³è½¬åˆ°å¯¹åº”ä¼šè¯ç›®å½•

---

## 5. Layer 2: ç¦»çº¿è½¬å½•ä¸ç¿»è¯‘ï¼ˆv40 + v41ï¼‰

### 5.1 ç”¨æˆ·æ•…äº‹

- ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘æƒ³å¯¹ä¸€ä¸ªå½•åˆ¶ä¼šè¯å‘èµ·"è½¬å½•"ä»»åŠ¡ï¼ŒæŠŠéŸ³é¢‘è½¬æˆæ–‡å­—
- æˆ‘å¯ä»¥åœ¨å½•åˆ¶å¼€å§‹æ—¶å°±æŒ‡å®š"å½•å®Œè‡ªåŠ¨è½¬å½•"ï¼Œä¹Ÿå¯ä»¥äº‹åæ‰‹åŠ¨å¯¹ç›®å½•å‘èµ·
- è½¬å½•æ”¯æŒæŒ‡å®šæºè¯­è¨€ï¼ˆæˆ–è‡ªåŠ¨æ£€æµ‹ï¼‰
- æˆ‘å¯ä»¥åŒæ—¶è¦æ±‚ç¿»è¯‘æˆç›®æ ‡è¯­è¨€ï¼ˆä»»æ„è¯­è¨€å¯¹ï¼šenâ†”zh, jaâ†”zh, zhâ†”en, jaâ†”en, ...ï¼‰
- è½¬å½•å’Œç¿»è¯‘çš„è¿›åº¦ã€çŠ¶æ€éƒ½ä»¥æ–‡ä»¶å½¢å¼å¯è§
- è½¬å½•æ˜¯åå°æ…¢ä»»åŠ¡ï¼Œä¸é˜»å¡ UI

### 5.2 è½ç›˜ç»“æ„ï¼ˆåœ¨å½•åˆ¶ä¼šè¯ç›®å½•å†…ï¼‰

```
{session_id}/
  _meta.json
  chunk_001.m4a
  chunk_002.m4a
  ...
  transcripts/                              # è½¬å½•ä»»åŠ¡æ ¹ç›®å½•
    _tasks.index.json                       # ä»»åŠ¡ç´¢å¼•
    {task_id}/                              # å•ä¸ªè½¬å½•/ç¿»è¯‘ä»»åŠ¡
      _task.json                            # ä»»åŠ¡çŠ¶æ€ï¼ˆVFS å¯è¯»ï¼‰
      _STATUS.md                            # äººç±»/Agent å¯è¯»çŠ¶æ€
      chunk_001.transcript.json             # åŸæ–‡ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
      chunk_001.translation.json            # è¯‘æ–‡ï¼ˆå¸¦æ—¶é—´æˆ³ï¼Œå¯é€‰ï¼‰
      chunk_002.transcript.json
      chunk_002.translation.json
      ...
```

### 5.3 `_task.json` Schema

```json
{
  "schema": "kotlin-agent-app/transcript-task@v1",
  "taskId": "tx_20260219_1600_x1y2z3",
  "sessionId": "rec_20260219_140000_a1b2c3",
  "state": "pending | in_progress | completed | failed | cancelled",
  "sourceLanguage": "ja",
  "targetLanguage": "zh",
  "autoTranslate": true,
  "progress": {
    "totalChunks": 12,
    "transcribedChunks": 7,
    "translatedChunks": 5,
    "failedChunks": 0
  },
  "asrProvider": "openai-whisper",
  "llmProvider": "openai-gpt4",
  "createdAt": "2026-02-19T16:05:00+08:00",
  "updatedAt": "2026-02-19T16:32:00+08:00",
  "error": null
}
```

### 5.4 `chunk_NNN.transcript.json` Schema

```json
{
  "schema": "kotlin-agent-app/transcript-chunk@v1",
  "taskId": "tx_20260219_1600_x1y2z3",
  "sourceChunk": "chunk_001.m4a",
  "chunkIndex": 1,
  "language": "ja",
  "durationSec": 600,
  "segments": [
    {
      "id": 1,
      "startSec": 0.0,
      "endSec": 3.2,
      "text": "ã“ã‚“ã«ã¡ã¯ã€NHKãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã™"
    },
    {
      "id": 2,
      "startSec": 3.2,
      "endSec": 7.8,
      "text": "ä»Šæ—¥ã®ãƒˆãƒƒãƒ—ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãŠä¼ãˆã—ã¾ã™"
    }
  ]
}
```

### 5.5 `chunk_NNN.translation.json` Schema

```json
{
  "schema": "kotlin-agent-app/translation-chunk@v1",
  "taskId": "tx_20260219_1600_x1y2z3",
  "sourceChunk": "chunk_001.m4a",
  "chunkIndex": 1,
  "sourceLanguage": "ja",
  "targetLanguage": "zh",
  "segments": [
    {
      "id": 1,
      "startSec": 0.0,
      "endSec": 3.2,
      "sourceText": "ã“ã‚“ã«ã¡ã¯ã€NHKãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã™",
      "translatedText": "ä½ å¥½ï¼Œè¿™é‡Œæ˜¯NHKä¸–ç•Œæ–°é—»"
    },
    {
      "id": 2,
      "startSec": 3.2,
      "endSec": 7.8,
      "sourceText": "ä»Šæ—¥ã®ãƒˆãƒƒãƒ—ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãŠä¼ãˆã—ã¾ã™",
      "translatedText": "ä¸ºæ‚¨æ’­æŠ¥ä»Šå¤©çš„å¤´æ¡æ–°é—»"
    }
  ]
}
```

### 5.6 `_tasks.index.json` Schema

```json
{
  "schema": "kotlin-agent-app/transcript-tasks-index@v1",
  "sessionId": "rec_20260219_140000_a1b2c3",
  "generatedAtSec": 1739952000,
  "tasks": [
    {
      "taskId": "tx_20260219_1600_x1y2z3",
      "dir": "tx_20260219_1600_x1y2z3",
      "state": "in_progress",
      "sourceLanguage": "ja",
      "targetLanguage": "zh",
      "progress": "7/12"
    }
  ]
}
```

### 5.7 è½¬å½•å¼•æ“è®¾è®¡

```
TranscriptTaskManager (Application-scoped singleton)
  â”œâ”€â”€ TaskQueue (FIFO, ä¸²è¡Œå¤„ç† chunkï¼Œé¿å… API å¹¶å‘çˆ†ç‚¸)
  â”‚     â”œâ”€â”€ AsrWorker: chunk.m4a â†’ Whisper API â†’ transcript.json
  â”‚     â””â”€â”€ TranslationWorker: transcript.json â†’ LLM API â†’ translation.json
  â”œâ”€â”€ çŠ¶æ€æŒä¹…åŒ–: æ¯å®Œæˆä¸€ä¸ª chunk ç«‹å³æ›´æ–° _task.json
  â””â”€â”€ WorkManager é›†æˆ: ç¡®ä¿ app è¢«æ€åä»»åŠ¡å¯æ¢å¤
```

å…³é”®å®ç°ç‚¹ï¼š

- ä¸²è¡Œå¤„ç† chunkï¼ˆä¸€ä¸ª chunk è½¬å½•å®Œå†ä¸‹ä¸€ä¸ªï¼‰ï¼Œé¿å… API å¹¶å‘é™åˆ¶é—®é¢˜
- æ¯å®Œæˆä¸€ä¸ª chunk çš„è½¬å½•/ç¿»è¯‘ï¼Œç«‹å³å†™ç›˜ï¼ˆ`transcript.json` / `translation.json`ï¼‰ï¼Œæ›´æ–° `_task.json` è¿›åº¦
- å¤±è´¥é‡è¯•ï¼šå•ä¸ª chunk æœ€å¤šé‡è¯• 3 æ¬¡ï¼Œè¶…è¿‡æ ‡è®°è¯¥ chunk ä¸º failedï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€ä¸ª
- Whisper API è°ƒç”¨ï¼šç›´æ¥ä¸Šä¼  `.m4a` æ–‡ä»¶ï¼Œè¯·æ±‚ `response_format=verbose_json`ï¼ˆå¸¦æ—¶é—´æˆ³ï¼‰
- LLM ç¿»è¯‘ï¼šæŒ‰ segment æ‰¹é‡ç¿»è¯‘ï¼ˆä¸€æ¬¡å‘ 10-20 ä¸ª segmentï¼‰ï¼Œä¿æŒæ—¶é—´æˆ³å¯¹é½
- ä»»åŠ¡å¯å–æ¶ˆï¼šç”¨æˆ·å¯åœ¨ UI æˆ– CLI å–æ¶ˆè¿›è¡Œä¸­çš„ä»»åŠ¡

### 5.8 å½•åˆ¶æ—¶è‡ªåŠ¨è§¦å‘è½¬å½•

`_meta.json` ä¸­çš„ `transcriptRequest` å­—æ®µï¼š

```json
{
  "transcriptRequest": {
    "autoStart": true,
    "sourceLanguage": "ja",
    "targetLanguage": "zh"
  }
}
```

å½“å½•åˆ¶å®Œæˆï¼ˆ`state=completed`ï¼‰æ—¶ï¼Œ`RadioRecordingService` æ£€æŸ¥æ­¤å­—æ®µï¼Œè‹¥ `autoStart=true`ï¼Œè‡ªåŠ¨åˆ›å»ºè½¬å½•ä»»åŠ¡ã€‚

ä¹Ÿæ”¯æŒ"è¾¹å½•è¾¹è½¬"æ¨¡å¼ï¼šæ¯äº§å‡ºä¸€ä¸ªæ–° chunkï¼Œç«‹å³æäº¤ç»™ `TranscriptTaskManager`ï¼ˆä½†éœ€è¦æ ‡è®°ä¸º `streaming` æ¨¡å¼ï¼Œchunk åˆ—è¡¨åŠ¨æ€å¢é•¿ï¼‰ã€‚

### 5.9 CLI æ‰©å±•

```
radio transcript start --session <sessionId> --source_lang ja [--target_lang zh]
radio transcript status --task <taskId>
radio transcript list --session <sessionId>
radio transcript cancel --task <taskId>
```

`radio record start` å¢åŠ å¯é€‰å‚æ•°ï¼š

```
radio record start --in <.radio> --duration_min 120 \
  --transcript_lang ja --translate_to zh
```

### 5.10 UI å…¥å£

- å½•åˆ¶ä¼šè¯ç›®å½•å†…ï¼Œæ˜¾ç¤º `transcripts/` å­ç›®å½•
- ç‚¹å‡»è¿›å…¥ `transcripts/` çœ‹åˆ°ä»»åŠ¡åˆ—è¡¨ï¼ˆä» `_tasks.index.json` æ¸²æŸ“ï¼‰
- ç‚¹å‡»ä»»åŠ¡ç›®å½•ï¼Œçœ‹åˆ° `_task.json` æ¸²æŸ“çš„è¿›åº¦å¡ç‰‡ + å·²å®Œæˆ chunk çš„è½¬å½•/ç¿»è¯‘æ–‡ä»¶åˆ—è¡¨
- å½•åˆ¶ä¼šè¯è¯¦æƒ…é¡µå¢åŠ "è½¬å½•"æŒ‰é’®ï¼Œå¼¹å‡ºè¯­è¨€é€‰æ‹©ï¼ˆæºè¯­è¨€ + ç›®æ ‡è¯­è¨€ï¼‰ï¼Œç¡®è®¤ååˆ›å»ºä»»åŠ¡
- ä¹Ÿå¯ä»¥åœ¨å½•åˆ¶ä¼šè¯ç›®å½•é•¿æŒ‰ â†’ "è½¬å½•æ­¤å½•éŸ³"

---

## 6. Layer 3: è¯­è¨€å­¦ä¹ äº¤äº’ï¼ˆv42ï¼‰

### 6.1 ç”¨æˆ·æ•…äº‹

- ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘æƒ³ç‚¹è¿›ä¸€ä¸ªè½¬å½•ä»»åŠ¡ç›®å½•ï¼Œçœ‹åˆ°åŒè¯­å¯¹ç…§çš„å­—å¹•è§†å›¾
- æˆ‘æƒ³ç‚¹å‡»æŸä¸€å¥ï¼Œè·³è½¬æ’­æ”¾å¯¹åº”æ—¶é—´ç‚¹çš„åŸå§‹éŸ³é¢‘
- æˆ‘æƒ³é•¿æŒ‰/é€‰ä¸­æŸå¥è¯ï¼Œå¼¹å‡ºè¯­è¨€å­¦ä¹  Agent é¢æ¿ï¼Œå¸®æˆ‘åˆ†æè¯­æ³•ã€æ‰©å±•ä¾‹å¥
- æˆ‘æƒ³æŠŠè½¬å½•æ–‡æœ¬ç”ŸæˆåŒè¯­å¬åŠ›ææ–™ï¼ˆTTSï¼‰ï¼Œç”¨äºç£¨è€³æœµ

### 6.2 åŒè¯­å­—å¹•è§†å›¾

å½“ç”¨æˆ·åœ¨ Files ä¸­ç‚¹å‡» `chunk_NNN.translation.json` æ—¶ï¼Œä¸æ˜¯å±•ç¤ºåŸå§‹ JSONï¼Œè€Œæ˜¯æ¸²æŸ“ä¸ºåŒè¯­å­—å¹•è§†å›¾ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  NHK World Â· chunk_001 Â· 00:00 - 10:00      â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  â–¶ 00:00  ã“ã‚“ã«ã¡ã¯ã€NHKãƒ¯ãƒ¼ãƒ«ãƒ‰ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã™     â”‚
â”‚           ä½ å¥½ï¼Œè¿™é‡Œæ˜¯NHKä¸–ç•Œæ–°é—»               â”‚
â”‚                                             â”‚
â”‚    00:03  ä»Šæ—¥ã®ãƒˆãƒƒãƒ—ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãŠä¼ãˆã—ã¾ã™       â”‚
â”‚           ä¸ºæ‚¨æ’­æŠ¥ä»Šå¤©çš„å¤´æ¡æ–°é—»                 â”‚
â”‚                                             â”‚
â”‚    00:07  ã¾ãšã€çµŒæ¸ˆãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã™                 â”‚
â”‚           é¦–å…ˆæ˜¯ç»æµæ–°é—»                        â”‚
â”‚  ...                                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

äº¤äº’ï¼š

- ç‚¹å‡»ä»»æ„ segment çš„æ—¶é—´æˆ³ â†’ è·³è½¬æ’­æ”¾å¯¹åº” chunk éŸ³é¢‘çš„å¯¹åº”ä½ç½®
- å½“å‰æ’­æ”¾ä½ç½®é«˜äº®å¯¹åº” segmentï¼ˆç±»ä¼¼æ­Œè¯åŒæ­¥ï¼‰
- æ”¯æŒçº¯åŸæ–‡ / çº¯è¯‘æ–‡ / åŒè¯­å¯¹ç…§ä¸‰ç§æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢

### 6.3 è¯­è¨€å­¦ä¹  Agent

é•¿æŒ‰/é€‰ä¸­æŸä¸ª segment åï¼Œåº•éƒ¨å¼¹å‡ºè¯­è¨€å­¦ä¹ é¢æ¿ï¼Œå†…åµŒä¸€ä¸ªä¸“ç”¨ Agentï¼ˆæ‹¥æœ‰ç‹¬ç«‹ `SKILL.md`ï¼‰ã€‚

`SKILL.md` è·¯å¾„ï¼š`app/src/main/assets/builtin_skills/language-tutor/SKILL.md`

Agent èƒ½åŠ›èŒƒå›´ï¼š

- è¯­æ³•è§£æï¼šæ‹†è§£å¥å­ç»“æ„ï¼Œæ ‡æ³¨è¯æ€§ã€æ—¶æ€ã€è¯­æ³•ç‚¹
- è¯æ±‡æ‰©å±•ï¼šç”Ÿè¯é‡Šä¹‰ã€åŒä¹‰è¯ã€å¸¸ç”¨æ­é…
- ä¾‹å¥ç”Ÿæˆï¼šå›´ç»•è¯¥è¯­æ³•ç‚¹æˆ–è¯æ±‡ï¼Œç”Ÿæˆ 2-3 ä¸ªéš¾åº¦é€’è¿›çš„ä¾‹å¥
- å‘éŸ³è¦ç‚¹ï¼šé’ˆå¯¹æ—¥è¯­çš„éŸ³è°ƒã€è‹±è¯­çš„è¿è¯»å¼±è¯»ç­‰
- æ–‡åŒ–èƒŒæ™¯ï¼šå¿…è¦æ—¶è¡¥å……è¯­å¢ƒï¼ˆå¦‚æ–°é—»ç”¨è¯­çš„æ­£å¼ç¨‹åº¦ï¼‰

Agent è¾“å…¥ä¸Šä¸‹æ–‡ï¼š

```json
{
  "selectedSegment": {
    "sourceText": "ä»Šæ—¥ã®ãƒˆãƒƒãƒ—ãƒ‹ãƒ¥ãƒ¼ã‚¹ã‚’ãŠä¼ãˆã—ã¾ã™",
    "translatedText": "ä¸ºæ‚¨æ’­æŠ¥ä»Šå¤©çš„å¤´æ¡æ–°é—»",
    "sourceLanguage": "ja",
    "targetLanguage": "zh",
    "startSec": 3.2,
    "endSec": 7.8
  },
  "surroundingSegments": [ ... ],
  "stationName": "NHK World",
  "userLevel": "intermediate"
}
```

Agent çš„å›å¤ç›´æ¥æ¸²æŸ“åœ¨åº•éƒ¨é¢æ¿ä¸­ï¼Œç”¨æˆ·å¯ä»¥ç»§ç»­è¿½é—®ï¼ˆå¦‚"è¿™ä¸ªè¯­æ³•è¿˜æœ‰ä»€ä¹ˆç”¨æ³•ï¼Ÿ"ï¼‰ã€‚

### 6.4 TTS åŒè¯­å¬åŠ›ææ–™ç”Ÿæˆ

åœ¨è½¬å½•ä»»åŠ¡ç›®å½•ä¸‹ï¼Œå¯ä»¥å‘èµ·"ç”ŸæˆåŒè¯­å¬åŠ›"ä»»åŠ¡ï¼š

```
{task_id}/
  audio_bilingual/                    # TTS ç”Ÿæˆçš„åŒè¯­å¬åŠ›
    _task.json                        # ç”Ÿæˆä»»åŠ¡çŠ¶æ€
    chunk_001_bilingual.m4a           # åŸæ–‡æœ—è¯» â†’ çŸ­æš‚åœé¡¿ â†’ è¯‘æ–‡æœ—è¯»
    chunk_002_bilingual.m4a
    ...
```

ä¸¤ç§ç”Ÿæˆæ¨¡å¼ï¼š

- ä»…è¯‘æ–‡æ¨¡å¼ï¼šåªæœ—è¯»è¯‘æ–‡ï¼Œé€‚åˆ"å¬è¯‘æ–‡ç†è§£å†…å®¹"
- äº¤æ›¿æ¨¡å¼ï¼šåŸæ–‡æœ—è¯»ï¼ˆåŸè¯­è¨€ TTSï¼‰â†’ 1 ç§’åœé¡¿ â†’ è¯‘æ–‡æœ—è¯»ï¼ˆç›®æ ‡è¯­è¨€ TTSï¼‰ï¼Œé€‚åˆ"å¯¹ç…§å­¦ä¹ "

`_task.json` å¤ç”¨ Layer 2 çš„ Task schema æ€è·¯ï¼š

```json
{
  "schema": "kotlin-agent-app/tts-bilingual-task@v1",
  "taskId": "tts_20260219_1700_m1n2o3",
  "parentTaskId": "tx_20260219_1600_x1y2z3",
  "mode": "interleaved",
  "sourceLanguage": "ja",
  "targetLanguage": "zh",
  "sourceTtsVoice": "ja-JP-Neural",
  "targetTtsVoice": "zh-CN-Neural",
  "state": "in_progress",
  "progress": { "totalChunks": 12, "completedChunks": 4 },
  "createdAt": "...",
  "updatedAt": "..."
}
```

### 6.5 CLI æ‰©å±•

```
radio tts start --task <transcriptTaskId> --mode interleaved|target_only \
  [--source_voice ja-JP-Neural] [--target_voice zh-CN-Neural]
radio tts status --task 

>
radio tts cancel --task <ttsTaskId>
```

---

## 7. Layer 4: å®æ—¶ç¿»è¯‘ç®¡çº¿ï¼ˆv43 + v44 + v45ï¼‰

### 7.1 ç”¨æˆ·æ•…äº‹

- ä½œä¸ºç”¨æˆ·ï¼Œæˆ‘æƒ³æ‰“å¼€ä¸€ä¸ªç”µå°åï¼Œå¼€å¯"å®æ—¶ç¿»è¯‘"æ¨¡å¼
- æˆ‘èƒ½çœ‹åˆ°å®æ—¶æ»šåŠ¨çš„åŒè¯­å­—å¹•ï¼ˆåŸæ–‡ + è¯‘æ–‡ï¼‰
- æˆ‘å¯ä»¥é€‰æ‹©ï¼šåªå¬åŸå£° + çœ‹å­—å¹•ï¼Œæˆ–è€…å¬è¯‘æ–‡è¯­éŸ³ï¼Œæˆ–è€…åŸå£°é™éŸ³é‡ + è¯‘æ–‡äº¤æ›¿æ’­æ”¾
- ç®¡çº¿è¿è¡ŒæœŸé—´ï¼Œæ‰€æœ‰ä¸­é—´äº§ç‰©ï¼ˆåŸå§‹éŸ³é¢‘ã€ASR æ–‡æœ¬ã€è¯‘æ–‡ã€TTS éŸ³é¢‘ï¼‰å¯é€‰è½ç›˜
- æˆ‘åœ¨å®æ—¶ç¿»è¯‘çš„åŒæ—¶ï¼Œè¿˜èƒ½åœ¨ Chat é¡µç­¾ç”¨éº¦å…‹é£å’Œ Agent å¯¹è¯

### 7.2 ç®¡çº¿æ¶æ„

```
Radio Stream (ExoPlayer - æ’­æ”¾ç”¨)
  â”‚
  â”œâ”€â†’ [AudioSink] â†’ æ‰¬å£°å™¨/è€³æœºï¼ˆåŸå£°ï¼‰
  â”‚                   â†‘ å¯è°ƒéŸ³é‡ï¼ˆäº¤æ›¿æ¨¡å¼æ—¶é™ä½ï¼‰
  â”‚
  â”œâ”€â†’ [AudioTee] â†’ PCM Buffer (5-10s çª—å£)
  â”‚                   â”‚
  â”‚                   â”œâ”€â†’ [å¯é€‰å½•åˆ¶] â†’ ChunkWriter â†’ .m4a è½ç›˜
  â”‚                   â”‚     ï¼ˆå¤ç”¨ Layer 1 çš„ RecordingSessionï¼‰
  â”‚                   â”‚
  â”‚                   â””â”€â†’ [ASR Buffer] â†’ æ”’æ»¡ ~8s â†’ Whisper API
  â”‚                         â”‚
  â”‚                         â”œâ”€â†’ åŸæ–‡ segment â†’ UI å®æ—¶å­—å¹•
  â”‚                         â”œâ”€â†’ [å¯é€‰è½ç›˜] â†’ live_transcript.jsonl
  â”‚                         â”‚
  â”‚                         â””â”€â†’ [LLM ç¿»è¯‘] â†’ è¯‘æ–‡ segment
  â”‚                               â”‚
  â”‚                               â”œâ”€â†’ UI å®æ—¶å­—å¹•ï¼ˆè¯‘æ–‡è¡Œï¼‰
  â”‚                               â”œâ”€â†’ [å¯é€‰è½ç›˜] â†’ live_translation.jsonl
  â”‚                               â”‚
  â”‚                               â””â”€â†’ [å¯é€‰ TTS] â†’ è¯‘æ–‡è¯­éŸ³
  â”‚                                     â”‚
  â”‚                                     â”œâ”€â†’ [å¯é€‰è½ç›˜] â†’ tts_chunks/
  â”‚                                     â””â”€â†’ éŸ³é¢‘è¾“å‡ºï¼ˆæ··éŸ³/äº¤æ›¿ï¼‰
```

### 7.3 AudioTee è®¾è®¡

æ ¸å¿ƒé—®é¢˜ï¼šå¦‚ä½•ä»æ­£åœ¨æ’­æ”¾çš„ ExoPlayer ä¸­"åˆ†å‰"å‡ºä¸€è·¯ PCM ç»™ ASRã€‚

æ–¹æ¡ˆï¼šè‡ªå®šä¹‰ `ForwardingAudioSink`ï¼ŒåŒ…è£…é»˜è®¤çš„ `DefaultAudioSink`ï¼š

```kotlin
class TeeAudioSink(
    private val delegate: DefaultAudioSink,
    private val tapCallback: (ByteBuffer, format: AudioFormat) -> Unit
) : ForwardingAudioSink(delegate) {

    override fun handleBuffer(
        buffer: ByteBuffer,
        presentationTimeUs: Long,
        encodedAccessUnitCount: Int
    ): Boolean {
        // åˆ†å‰ï¼šæŠŠ PCM æ•°æ®æ‹·è´ä¸€ä»½ç»™ tap
        tapCallback(buffer.duplicate(), currentFormat)
        // åŸè·¯å¾„ï¼šç»§ç»­é€ç»™çœŸå® AudioSink æ’­æ”¾
        return delegate.handleBuffer(buffer, presentationTimeUs, encodedAccessUnitCount)
    }
}
```

`tapCallback` æŠŠ PCM æ•°æ®æ¨å…¥ä¸€ä¸ªç¯å½¢ç¼“å†²åŒºï¼ˆ`RingBuffer`ï¼‰ï¼ŒASR æ¨¡å—ä»ä¸­æ¶ˆè´¹ã€‚

### 7.4 ASR æµå¼å¤„ç†

Whisper API ä¸æ”¯æŒçœŸæ­£çš„æµå¼è¾“å…¥ï¼Œé‡‡ç”¨"ä¼ªæµå¼"ç­–ç•¥ï¼š

```
RingBuffer (PCM, ~30s å®¹é‡)
  â”‚
  â””â”€â†’ AsrStreamProcessor
        â”œâ”€â”€ æ”’æ»¡ ~8 ç§’ PCM
        â”œâ”€â”€ ç¼–ç ä¸ºä¸´æ—¶ .m4aï¼ˆå†…å­˜ä¸­æˆ–ä¸´æ—¶æ–‡ä»¶ï¼‰
        â”œâ”€â”€ è°ƒç”¨ Whisper API (response_format=verbose_json)
        â”œâ”€â”€ è§£æ segmentsï¼Œé™„åŠ å…¨å±€æ—¶é—´åç§»
        â”œâ”€â”€ å‘å°„åˆ° Flow<AsrSegment>
        â””â”€â”€ å¾ªç¯
```

å»¶è¿Ÿé¢„ç®—ï¼ˆç›®æ ‡ â‰¤10sï¼‰ï¼š

| é˜¶æ®µ | é¢„ä¼°è€—æ—¶ |
|------|----------|
| PCM æ”’ buffer | ~8sï¼ˆå¯è°ƒï¼Œ5-10sï¼‰ |
| ç¼–ç ä¸º .m4a | <0.5s |
| Whisper API è°ƒç”¨ | 1-3sï¼ˆå–å†³äºç½‘ç»œå’ŒéŸ³é¢‘é•¿åº¦ï¼‰ |
| æ€»è®¡ | ~9-11s |

é€šè¿‡è°ƒæ•´ buffer é•¿åº¦ï¼ˆ5-8sï¼‰å¯ä»¥æŠŠæ€»å»¶è¿Ÿæ§åˆ¶åœ¨ 10s ä»¥å†…ã€‚

### 7.5 LLM ç¿»è¯‘ï¼ˆæµå¼ï¼‰

ASR è¾“å‡ºçš„ segments æ”’ 3-5 å¥åï¼Œæ‰¹é‡å‘ç»™ LLM ç¿»è¯‘ï¼š

- ä½¿ç”¨ streaming APIï¼ˆSSEï¼‰ï¼Œè¯‘æ–‡é€å¥åˆ°è¾¾å³æ¨é€ UI
- ç¿»è¯‘ prompt éœ€è¦æºå¸¦å‰å‡ å¥çš„ä¸Šä¸‹æ–‡ï¼ˆsliding windowï¼‰ï¼Œä¿è¯è¯‘æ–‡è¿è´¯
- é¢„ä¼°é¢å¤–å»¶è¿Ÿï¼š1-3s

### 7.6 TTS è¾“å‡ºä¸æ··éŸ³

ä¸¤ç§æ’­æ”¾æ¨¡å¼çš„å®ç°ï¼š

**æ¨¡å¼ Aï¼šä»…è¯‘æ–‡è¯­éŸ³**

- åŸå£°é™éŸ³ï¼ˆæˆ–æä½éŸ³é‡ï¼‰
- TTS ç”Ÿæˆçš„è¯‘æ–‡éŸ³é¢‘é€šè¿‡ç‹¬ç«‹çš„ `AudioTrack` æ’­æ”¾
- ç®€å•ç›´æ¥ï¼Œæ— æ··éŸ³é—®é¢˜

**æ¨¡å¼ Bï¼šåŸå£°é™éŸ³é‡ + è¯‘æ–‡äº¤æ›¿**

```
æ—¶é—´çº¿ï¼š
  [åŸå£° 100%] â”€â”€â†’ [åŸå£°é™è‡³ 20%] â”€â”€â†’ [TTS è¯‘æ–‡æ’­æ”¾] â”€â”€â†’ [åŸå£°æ¢å¤ 100%] â”€â”€â†’ ...
                   â†‘ ASR+ç¿»è¯‘å®Œæˆï¼Œ    â†‘ è¯‘æ–‡æœ—è¯»æœŸé—´      â†‘ è¯‘æ–‡æ’­å®Œ
                     å‡†å¤‡æ’å…¥è¯‘æ–‡        åŸå£°ä¿æŒä½éŸ³é‡
```

å®ç°ï¼š

- åŸå£°éŸ³é‡é€šè¿‡ `ExoPlayer.setVolume()` åŠ¨æ€è°ƒèŠ‚
- TTS éŸ³é¢‘é€šè¿‡ç‹¬ç«‹ `AudioTrack`ï¼ˆä¸åŒ AudioSessionï¼‰æ’­æ”¾
- ä¸€ä¸ª `MixController` åè°ƒæ—¶åºï¼šæ”¶åˆ°è¯‘æ–‡ TTS éŸ³é¢‘ â†’ é™ä½åŸå£°éŸ³é‡ â†’ æ’­æ”¾ TTS â†’ TTS æ’­å®Œ â†’ æ¢å¤åŸå£°éŸ³é‡
- å¦‚æœ TTS æ¥ä¸åŠï¼ˆè¯‘æ–‡è¿˜æ²¡ç”Ÿæˆå®Œï¼‰ï¼ŒåŸå£°æ­£å¸¸æ’­æ”¾ä¸å—å½±å“

### 7.7 å®æ—¶ç®¡çº¿è½ç›˜ï¼ˆå¯é€‰ï¼‰

ç”¨æˆ·å¯åœ¨å¯åŠ¨å®æ—¶ç¿»è¯‘æ—¶é€‰æ‹©æ˜¯å¦è½ç›˜ï¼Œè½ç›˜ç»“æ„å¤ç”¨ Layer 1 + Layer 2ï¼š

```
.agents/workspace/radio_recordings/
  live_20260219_200000_p1q2r3/          # å®æ—¶ç¿»è¯‘ä¼šè¯
    _meta.json                          # type: "live_translation"
    _STATUS.md
    chunk_001.m4a                       # åŸå§‹éŸ³é¢‘åˆ‡ç‰‡ï¼ˆå¤ç”¨ Layer 1ï¼‰
    chunk_002.m4a
    live_transcript.jsonl               # ASR åŸæ–‡æµæ°´ï¼ˆè¿½åŠ å†™å…¥ï¼‰
    live_translation.jsonl              # è¯‘æ–‡æµæ°´ï¼ˆè¿½åŠ å†™å…¥ï¼‰
    tts_chunks/                         # TTS éŸ³é¢‘ç‰‡æ®µï¼ˆå¯é€‰ï¼‰
      tts_seg_001.m4a
      tts_seg_002.m4a
      ...
```

`live_transcript.jsonl` æ¯è¡Œä¸€ä¸ª segmentï¼š

```json
{"ts":"2026-02-19T20:01:08Z","startSec":60.0,"endSec":63.2,"lang":"ja","text":"æ¬¡ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã™"}
```

`live_translation.jsonl` æ¯è¡Œä¸€ä¸ªç¿»è¯‘ segmentï¼š

```json
{"ts":"2026-02-19T20:01:10Z","startSec":60.0,"endSec":63.2,"sourceLang":"ja","targetLang":"zh","sourceText":"æ¬¡ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã™","translatedText":"ä¸‹é¢æ˜¯ä¸‹ä¸€æ¡æ–°é—»"}
```

è¿™äº› JSONL æ–‡ä»¶åœ¨å®æ—¶ç®¡çº¿ç»“æŸåï¼Œå¯ä»¥è¢« Layer 2 çš„å·¥å…·è½¬æ¢ä¸ºæ ‡å‡†çš„ `transcript.json` / `translation.json` æ ¼å¼ï¼Œè¿›å…¥è¯­è¨€å­¦ä¹ æµç¨‹ã€‚

### 7.8 å®æ—¶ç¿»è¯‘ UI

æ’­æ”¾å™¨ç•Œé¢æ‰©å±•ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â–¶ NHK World  â—LIVE  ğŸ”´ç¿»è¯‘ä¸­               â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚                                             â”‚
â”‚  [å®æ—¶å­—å¹•åŒºåŸŸï¼Œè‡ªåŠ¨æ»šåŠ¨]                      â”‚
â”‚                                             â”‚
â”‚  20:01:05  æ¬¡ã®ãƒ‹ãƒ¥ãƒ¼ã‚¹ã§ã™                    â”‚
â”‚            ä¸‹é¢æ˜¯ä¸‹ä¸€æ¡æ–°é—»                    â”‚
â”‚                                             â”‚
â”‚  20:01:08  æ±äº¬æ ªå¼å¸‚å ´ã¯ä»Šæ—¥...                â”‚
â”‚            ä¸œäº¬è‚¡å¸‚ä»Šå¤©...                     â”‚
â”‚                                             â”‚
â”‚  20:01:12  (æ­£åœ¨è¯†åˆ«...)                      â”‚
â”‚                                             â”‚
â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
â”‚  ğŸ”Š åŸå£°+è¯‘æ–‡äº¤æ›¿  |  ğŸ”Š ä»…è¯‘æ–‡  |  ğŸ”‡ ä»…å­—å¹•  â”‚
â”‚  [å½•åˆ¶ â—]  [è½ç›˜ âœ“]                          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 7.9 CLI æ‰©å±•

```
radio live start --in <.radio path> --source_lang ja --target_lang zh \
  [--mode interleaved|target_only|subtitle_only] \
  [--save_audio] [--save_transcript] [--save_tts]
radio live stop
radio live status
```

---

## 8. ASR / TTS ç‹¬ç«‹æ¨¡å—ï¼ˆv43ï¼Œä¸º Layer 4 å’Œ Chat åšå‡†å¤‡ï¼‰

### 8.1 è®¾è®¡ç›®æ ‡

ASR å’Œ TTS ä¸ä»…æœåŠ¡äº Radio ç®¡çº¿ï¼Œä¹Ÿè¦æœåŠ¡äº Chat é¡µç­¾çš„è¯­éŸ³äº¤äº’ã€‚å› æ­¤éœ€è¦æŠ½è±¡ä¸ºç‹¬ç«‹æ¨¡å—ã€‚

### 8.2 ASR æ¨¡å—

```kotlin
interface AsrService {
    /**
     * è½¬å½•éŸ³é¢‘æ–‡ä»¶ï¼ˆç¦»çº¿ï¼ŒLayer 2 ä½¿ç”¨ï¼‰
     */
    suspend fun transcribeFile(
        audioFile: File,
        language: String? = null,  // null = è‡ªåŠ¨æ£€æµ‹
        responseFormat: AsrResponseFormat = AsrResponseFormat.VERBOSE_JSON
    ): AsrResult

    /**
     * è½¬å½•éŸ³é¢‘æµï¼ˆå®æ—¶ï¼ŒLayer 4 å’Œ Chat ä½¿ç”¨ï¼‰
     * è°ƒç”¨æ–¹æ¨é€ PCM æ•°æ®ï¼ŒASR æ¨¡å—æŒ‰ buffer ç­–ç•¥æ”’å¤Ÿåè°ƒç”¨ API
     */
    fun transcribeStream(
        audioSource: Flow<PcmChunk>,
        language: String? = null,
        bufferDurationSec: Float = 8f
    ): Flow<AsrSegment>
}

data class AsrSegment(
    val startSec: Float,
    val endSec: Float,
    val text: String,
    val language: String,
    val confidence: Float? = null
)
```

å®ç°ï¼š`CloudAsrService`ï¼ˆå°è£… Whisper API è°ƒç”¨ï¼‰ã€‚

å¹¶å‘éš”ç¦»ï¼š

- æ¯ä¸ªè°ƒç”¨æ–¹ï¼ˆRadio ç®¡çº¿ / Chat è¯­éŸ³è¾“å…¥ï¼‰è·å¾—ç‹¬ç«‹çš„åç¨‹ä½œç”¨åŸŸ
- API è°ƒç”¨é€šè¿‡ `Semaphore(maxConcurrent=3)` é™æµï¼Œé¿å…å¹¶å‘çˆ†ç‚¸
- Chat è¯­éŸ³è¾“å…¥ä¼˜å…ˆçº§é«˜äº Radio ç®¡çº¿ï¼ˆç”¨æˆ·ç›´æ¥äº¤äº’ > åå°ç®¡çº¿ï¼‰

### 8.3 TTS æ¨¡å—

```kotlin
interface TtsService {
    /**
     * åˆæˆå•æ®µæ–‡æœ¬ï¼ˆç¦»çº¿æ‰¹é‡ + å®æ—¶ç®¡çº¿é€šç”¨ï¼‰
     */
    suspend fun synthesize(
        text: String,
        language: String,
        voice: String? = null,       // null = ä½¿ç”¨è¯¥è¯­è¨€é»˜è®¤ voice
        speed: Float = 1.0f
    ): TtsResult

    /**
     * æµå¼åˆæˆï¼ˆå®æ—¶ç®¡çº¿ä½¿ç”¨ï¼Œè¾¹ç”Ÿæˆè¾¹æ’­æ”¾ï¼‰
     */
    fun synthesizeStream(
        textSegments: Flow<String>,
        language: String,
        voice: String? = null
    ): Flow<TtsAudioChunk>
}

data class TtsResult(
    val audioData: ByteArray,
    val format: AudioFormat,       // AAC, MP3, PCM ç­‰
    val durationSec: Float
)
```

TTS åç«¯é€‰æ‹©ï¼ˆäº‘ç«¯ï¼‰ï¼š

- é¦–é€‰ï¼šOpenAI TTS APIï¼ˆè´¨é‡å¥½ï¼Œå¤šè¯­è¨€æ”¯æŒï¼‰
- å¤‡é€‰ï¼šAzure Cognitive Services TTSï¼ˆè¯­è¨€è¦†ç›–æ›´å¹¿ï¼Œå°¤å…¶äºšæ´²è¯­è¨€ï¼‰
- é€šè¿‡ `TtsProvider` æ¥å£æŠ½è±¡ï¼ŒSettings ä¸­å¯åˆ‡æ¢

### 8.4 Chat é¡µç­¾é›†æˆï¼ˆæ¦‚è¦ï¼‰

Chat é¡µç­¾å½“å‰æ˜¯çº¯æ–‡æœ¬äº¤äº’ã€‚å¼•å…¥ ASR/TTS æ¨¡å—åï¼š

- éº¦å…‹é£æŒ‰é’® â†’ å½•éŸ³ â†’ `AsrService.transcribeStream()` â†’ æ–‡æœ¬è¾“å…¥æ¡†
- Agent å›å¤ â†’ å¯é€‰ TTS æœ—è¯» â†’ `TtsService.synthesize()` â†’ æ‰¬å£°å™¨

ä¸ Radio å®æ—¶ç®¡çº¿å¹¶å‘æ—¶çš„éŸ³é¢‘è·¯ç”±ï¼š

```
                    â”Œâ”€ Radio åŸå£° â”€â”€â†’ è€³æœºï¼ˆå·¦å³å£°é“ / é™éŸ³é‡ï¼‰
AudioFocusManager â”€â”€â”¤
                    â”œâ”€ Radio TTS è¯‘æ–‡ â”€â”€â†’ è€³æœºï¼ˆæ’å…¥é—´éš™ï¼‰
                    â”‚
                    â””â”€ Chat TTS å›å¤ â”€â”€â†’ æš‚åœ Radio TTS â†’ æ’­æ”¾ Chat TTS â†’ æ¢å¤
```

- Chat TTS æ‹¥æœ‰æœ€é«˜ä¼˜å…ˆçº§ï¼šå½“ Agent å›å¤éœ€è¦æœ—è¯»æ—¶ï¼Œæš‚åœ Radio çš„ TTS è¾“å‡ºï¼ˆåŸå£°å¯ç»§ç»­ä½éŸ³é‡æ’­æ”¾ï¼‰
- éº¦å…‹é£è¾“å…¥ä¸ Radio æ’­æ”¾äº’ä¸å¹²æ‰°ï¼ˆéº¦å…‹é£èµ°ç‹¬ç«‹çš„ `AudioRecord`ï¼Œä¸ `AudioTrack` è¾“å‡ºæ˜¯ç‹¬ç«‹é€šé“ï¼‰

---

## 9. Files é¡µç­¾æ¼”è¿›ï¼ˆè·¨ç‰ˆæœ¬ï¼‰

### 9.1 å½“å‰ VFS å…¥å£å…¨æ™¯

```
.agents/workspace/
  radios/                    # ç”µå°ï¼ˆv38ï¼Œå·²å®Œæˆï¼‰
  radio_recordings/          # å½•åˆ¶ + è½¬å½• + TTSï¼ˆv39-v45ï¼Œæœ¬ PRDï¼‰
  music/                     # éŸ³ä¹ï¼ˆå·²å®Œæˆï¼‰
  ledger/                    # è®°è´¦ï¼ˆå·²å®Œæˆï¼‰
  stocks/                    # è‚¡ç¥¨ï¼ˆå·²å®Œæˆï¼Œå¾…æ¥å…¥ VFSï¼‰
  ...
```

### 9.2 éœ€è¦å¢å¼ºçš„èƒ½åŠ›

**a) ç›®å½•ç±»å‹æ„ŸçŸ¥æ¸²æŸ“å™¨ï¼ˆFile Type Rendererï¼‰**

ä¸åŒæ–‡ä»¶/ç›®å½•ç±»å‹éœ€è¦ä¸åŒçš„æ¸²æŸ“æ–¹å¼ï¼š

| æ–‡ä»¶/ç›®å½•æ¨¡å¼ | æ¸²æŸ“å™¨ |
|--------------|--------|
| `*.radio` | ç”µå°å¡ç‰‡ï¼ˆåç§°ã€å›½å®¶ã€faviconã€æ’­æ”¾æŒ‰é’®ï¼‰ |
| `_meta.json`ï¼ˆrecordingï¼‰ | å½•åˆ¶çŠ¶æ€å¡ç‰‡ï¼ˆç”µå°åã€æ—¶é•¿ã€è¿›åº¦ã€chunk æ•°ï¼‰ |
| `_task.json`ï¼ˆtranscriptï¼‰ | è½¬å½•ä»»åŠ¡å¡ç‰‡ï¼ˆè¿›åº¦æ¡ã€æºè¯­è¨€â†’ç›®æ ‡è¯­è¨€ï¼‰ |
| `*.transcript.json` | åŸæ–‡å­—å¹•è§†å›¾ |
| `*.translation.json` | åŒè¯­å­—å¹•è§†å›¾ï¼ˆLayer 3ï¼‰ |
| `_STATUS.md` | çŠ¶æ€/é”™è¯¯è¯´æ˜ï¼ˆMarkdown æ¸²æŸ“ï¼‰ |
| å…¶ä»– `.json` | é€šç”¨ JSON æŸ¥çœ‹å™¨ |
| `*.m4a` | éŸ³é¢‘æ’­æ”¾æ¡ |

å®ç°å»ºè®®ï¼š`FileRendererRegistry`ï¼Œæ ¹æ®æ–‡ä»¶åæ¨¡å¼ + çˆ¶ç›®å½•ä¸Šä¸‹æ–‡åŒ¹é…æ¸²æŸ“å™¨ã€‚

**b) é¢åŒ…å±‘å¯¼èˆªå¢å¼º**

ç›®å½•å±‚çº§è¶Šæ¥è¶Šæ·±ï¼ˆ`radio_recordings/{session}/transcripts/{task}/chunk_001.translation.json`ï¼‰ï¼Œéœ€è¦ï¼š

- å¯ç‚¹å‡»çš„é¢åŒ…å±‘è·¯å¾„æ 
- é•¿æŒ‰é¢åŒ…å±‘æŸä¸€çº§ â†’ å¿«é€Ÿè·³è½¬
- æ”¶è—ç›®å½• / æœ€è¿‘è®¿é—®ï¼ˆå¯é€‰ï¼‰

**c) ç›®å½•çº§æ“ä½œèœå•**

è¿›å…¥æŸäº›ç‰¹æ®Šç›®å½•æ—¶ï¼Œé¡¶éƒ¨æˆ–æµ®åŠ¨æŒ‰é’®æä¾›ä¸Šä¸‹æ–‡æ“ä½œï¼š

- è¿›å…¥å½•åˆ¶ä¼šè¯ç›®å½• â†’ "è½¬å½•æ­¤å½•éŸ³" / "åœæ­¢å½•åˆ¶"
- è¿›å…¥è½¬å½•ä»»åŠ¡ç›®å½• â†’ "ç”ŸæˆåŒè¯­å¬åŠ›" / "å–æ¶ˆä»»åŠ¡"
- è¿›å…¥ `radios/{country}/` â†’ "åˆ·æ–°ç”µå°åˆ—è¡¨"

---

## 10. å®‰å…¨ä¸éšç§è¡¥å……

### 10.1 å½•åˆ¶

- å½•åˆ¶ä»…é™ `radios/` å­æ ‘å†…çš„ `.radio` æ–‡ä»¶ä½œä¸ºæºï¼Œä¸å…è®¸å½•åˆ¶ä»»æ„ URL
- å½•åˆ¶äº§ç‰©å­˜å‚¨åœ¨ app å†…éƒ¨å­˜å‚¨ï¼ˆ`.agents/workspace/`ï¼‰ï¼Œä¸æš´éœ²ç»™å…¶ä»– app
- CLI `radio record start` å— `terminal_exec` ç™½åå•ä¸å®¡è®¡æœºåˆ¶ä¿æŠ¤

### 10.2 ASR / ç¿»è¯‘

- éŸ³é¢‘æ•°æ®å‘é€åˆ°äº‘ç«¯ APIï¼ˆWhisper / LLMï¼‰ï¼Œéœ€è¦åœ¨ Settings ä¸­æ˜ç¡®å‘ŠçŸ¥ç”¨æˆ·
- API Key å­˜å‚¨åœ¨ app çš„ EncryptedSharedPreferences ä¸­ï¼Œä¸è½ç›˜åˆ° workspace
- è½¬å½•/ç¿»è¯‘ç»“æœä»…å­˜å‚¨åœ¨æœ¬åœ° workspaceï¼Œä¸ä¸Šä¼ 

### 10.3 å®æ—¶ç®¡çº¿

- å®æ—¶ç®¡çº¿çš„éŸ³é¢‘æµæŒç»­å‘é€åˆ°äº‘ç«¯ ASRï¼Œéœ€è¦åœ¨å¯åŠ¨æ—¶æ˜ç¡®æç¤ºç”¨æˆ·
- è½ç›˜çš„ JSONL å’ŒéŸ³é¢‘åˆ‡ç‰‡éµå¾ªä¸ ListeningHistory ç›¸åŒçš„éšç§å£å¾„ï¼šè·¯å¾„é€æ˜ã€å¯ä¸€é”®æ¸…ç©ºã€æ¸…ç©ºéœ€äºŒæ¬¡ç¡®è®¤

---

## 11. äº¤ä»˜è®¡åˆ’

| ç‰ˆæœ¬ | å±‚ | èŒƒå›´ | æ ¸å¿ƒäº¤ä»˜ç‰© |
|------|-----|------|-----------|
| v39 | Layer 1 | åå°å½•åˆ¶ | RecordingService, ChunkWriter, CLI `radio record`, å½•åˆ¶ç›®å½• VFS, UI å½•åˆ¶æŒ‰é’® |
| v40 | Layer 2a | ç¦»çº¿è½¬å½• | TranscriptTaskManager, AsrWorker (Whisper API), transcript.json è½ç›˜, CLI `radio transcript`, ä»»åŠ¡çŠ¶æ€ VFS |
| v41 | Layer 2b | ç¦»çº¿ç¿»è¯‘ | TranslationWorker (LLM), translation.json è½ç›˜, å½•åˆ¶æ—¶è‡ªåŠ¨è½¬å½•+ç¿»è¯‘, "è¾¹å½•è¾¹è½¬"æ¨¡å¼ |
| v42 | Layer 3 | è¯­è¨€å­¦ä¹  | åŒè¯­å­—å¹•è§†å›¾, éŸ³é¢‘å®šä½æ’­æ”¾, è¯­è¨€å­¦ä¹  Agent (SKILL.md), TTS åŒè¯­å¬åŠ›ç”Ÿæˆ |
| v43 | åŸºç¡€è®¾æ–½ | ASR/TTS æ¨¡å—åŒ– | AsrService / TtsService æ¥å£ä¸äº‘ç«¯å®ç°, Chat è¯­éŸ³è¾“å…¥/è¾“å‡ºé›†æˆ, å¹¶å‘éš”ç¦» |
| v44 | Layer 4a | å®æ—¶ç¿»è¯‘ MVP | AudioTee, AsrStreamProcessor, LLM æµå¼ç¿»è¯‘, å®æ—¶å­—å¹• UI, CLI `radio live` |
| v45 | Layer 4b | å®æ—¶ç¿»è¯‘å®Œæ•´ç‰ˆ | TTS è¾“å‡º, åŒæ¨¡å¼æ··éŸ³(ä»…è¯‘æ–‡/äº¤æ›¿), å…¨é“¾è·¯è½ç›˜, AudioFocusManager ä¸ Chat å¹¶å‘ |

### 11.1 å„ç‰ˆæœ¬å‰ç½®ä¾èµ–

```
v39 (å½•åˆ¶) â† æ— å¤–éƒ¨ä¾èµ–ï¼Œå¯ç«‹å³å¼€å§‹
v40 (è½¬å½•) â† v39 + OpenAI Whisper API Key é…ç½®
v41 (ç¿»è¯‘) â† v40 + LLM ç¿»è¯‘ prompt è°ƒä¼˜
v42 (è¯­è¨€å­¦ä¹ ) â† v41 + TTS API æ¥å…¥
v43 (ASR/TTS æ¨¡å—åŒ–) â† v42 çš„ TTS ç»éªŒï¼Œé‡æ„ä¸ºç‹¬ç«‹æ¨¡å—
v44 (å®æ—¶ç¿»è¯‘ MVP) â† v43
v45 (å®æ—¶ç¿»è¯‘å®Œæ•´) â† v44
```

---

## 12. å¼€æ”¾é—®é¢˜ï¼ˆå¾…åç»­è®¨è®ºï¼‰

| # | é—®é¢˜ | å½±å“èŒƒå›´ | å»ºè®® |
|---|------|---------|------|
| 1 | Whisper API å•æ¬¡è°ƒç”¨çš„éŸ³é¢‘é•¿åº¦ä¸Šé™ï¼ˆå½“å‰ 25MB / ~25minï¼‰æ˜¯å¦å¤Ÿç”¨ï¼Ÿ10min chunk çº¦ 9.6MBï¼Œå®‰å…¨ | v40 | å½“å‰ 10min åˆ‡ç‰‡ç­–ç•¥å®‰å…¨ï¼Œæ— éœ€è°ƒæ•´ |
| 2 | LLM ç¿»è¯‘çš„ä¸Šä¸‹æ–‡çª—å£ï¼šé•¿èŠ‚ç›®çš„ç¿»è¯‘ä¸€è‡´æ€§ï¼ˆæœ¯è¯­ã€äººåï¼‰å¦‚ä½•ä¿è¯ï¼Ÿ | v41 | è€ƒè™‘ç»´æŠ¤ä¸€ä¸ª session çº§çš„æœ¯è¯­è¡¨ / æ‘˜è¦ï¼Œä½œä¸ºç¿»è¯‘ prompt çš„ system context |
| 3 | TTS è¯­éŸ³é€‰æ‹©ï¼šä¸åŒè¯­è¨€çš„æœ€ä½³ voice å¦‚ä½•è®©ç”¨æˆ·é…ç½®ï¼Ÿ | v42 | Settings ä¸­æŒ‰è¯­è¨€é…ç½®é»˜è®¤ voiceï¼Œä¹Ÿå¯åœ¨ä»»åŠ¡åˆ›å»ºæ—¶è¦†ç›– |
| 4 | å®æ—¶ç®¡çº¿çš„ç½‘ç»œä¸­æ–­æ¢å¤ï¼šASR è°ƒç”¨å¤±è´¥æ—¶ï¼Œbuffer ä¸­çš„éŸ³é¢‘æ˜¯ä¸¢å¼ƒè¿˜æ˜¯é‡è¯•ï¼Ÿ | v44 | å»ºè®®ï¼šçŸ­æš‚å¤±è´¥é‡è¯• 1 æ¬¡ï¼Œè¶…æ—¶åˆ™ä¸¢å¼ƒè¯¥ buffer å¹¶åœ¨å­—å¹•åŒºæ˜¾ç¤º"[è¯†åˆ«ä¸­æ–­]"ï¼Œç»§ç»­å¤„ç†ä¸‹ä¸€æ®µ |
| 5 | è´¹ç”¨é¢„ä¼°ï¼šé•¿æ—¶é—´å®æ—¶ç¿»è¯‘çš„ API æˆæœ¬ï¼ˆWhisper + LLM + TTSï¼‰éœ€è¦ç»™ç”¨æˆ·ä¸€ä¸ªå¤§è‡´å‚è€ƒ | v44 | åœ¨å¯åŠ¨å®æ—¶ç¿»è¯‘æ—¶æ˜¾ç¤ºé¢„ä¼°è´¹ç”¨æç¤ºï¼ˆæŒ‰å°æ—¶ä¼°ç®—ï¼‰ |
| 6 | stocks æ¨¡å—æ¥å…¥ VFS çš„æ—¶é—´ç‚¹ | è·¨ç‰ˆæœ¬ | å¯ä¸ v39-v41 å¹¶è¡Œæ¨è¿›ï¼Œä¸é˜»å¡æœ¬ PRD |
```

---

PRD å†™å®Œäº†ã€‚ä» v39 åˆ° v45ï¼Œä¸ƒä¸ªç‰ˆæœ¬ï¼Œä»"èƒ½å½•"åˆ°"èƒ½å®æ—¶ç¿»è¯‘ç€å¬"ï¼Œé€å±‚å åŠ ã€‚æ¯ä¸€å±‚éƒ½èƒ½ç‹¬ç«‹äº¤ä»˜ä½¿ç”¨ä»·å€¼ï¼Œä¸ç”¨ç­‰å…¨åšå®Œæ‰èƒ½ç”¨ã€‚

æŸ æª¬å”çœ‹çœ‹æœ‰æ²¡æœ‰è¦è°ƒæ•´çš„åœ°æ–¹ï¼Ÿ