# v42 Planï¼šåŒè¯­å­¦ä¹ æ’­æ”¾å™¨

## Goal

æä¾›ä¸€ä¸ªä¸“é—¨çš„åŒè¯­æ’­æ”¾å™¨ï¼Œç”¨äºå›æ”¾ç”µå°å½•éŸ³å¹¶åŒæ­¥å±•ç¤ºåŒè¯­å­—å¹•ï¼š

- é•¿æŒ‰å½•éŸ³ session ç›®å½• â†’ å¯åŠ¨åŒè¯­æ’­æ”¾å™¨
- é¡ºåºæ’­æ”¾ session å†…æ‰€æœ‰ chunk_NNN.ogg
- åŒæ­¥æ¸²æŸ“å¯¹åº”çš„ translation.json åŒè¯­å­—å¹•ï¼Œæ’­æ”¾ä½ç½®é«˜äº® + è‡ªåŠ¨æ»šåŠ¨
- æ”¯æŒå˜é€Ÿæ’­æ”¾ï¼ˆ0.5x / 0.75x / 1.0x / 1.25x / 1.5x / 2.0xï¼‰ï¼Œæ–¹ä¾¿è¯­è¨€å­¦ä¹ 

## PRD Trace

- PRD-0034ï¼šREQ-0034-100 / REQ-0034-101 / REQ-0034-102

## Scope

åšï¼ˆv42ï¼‰ï¼š

- åŒè¯­æ’­æ”¾å™¨å…¨å±é¡µé¢ï¼ˆç‹¬ç«‹ Activity æˆ–å…¨å± Composable Routeï¼‰
- éŸ³é¢‘æ’­æ”¾ï¼šé¡ºåºæ’­æ”¾ session å†…æ‰€æœ‰ oggï¼Œchunk ä¹‹é—´æ— ç¼è¡”æ¥
- åŒè¯­å­—å¹•åŒæ­¥ï¼šæ ¹æ®æ’­æ”¾ä½ç½®å®æ—¶é«˜äº®å½“å‰ segmentï¼Œè‡ªåŠ¨æ»šåŠ¨
- æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢ï¼šåŸæ–‡ / è¯‘æ–‡ / åŒè¯­å¯¹ç…§
- å˜é€Ÿæ’­æ”¾ï¼š0.5x / 0.75x / 1.0x / 1.25x / 1.5x / 2.0x
- ç®€å•çš„éŸ³é¢‘æ³¢çº¹åŠ¨ç”»ï¼ˆè¡¨ç¤ºæ­£åœ¨æ’­æ”¾ï¼‰
- ç‚¹å‡»å­—å¹•å¥å­ â†’ seek åˆ°å¯¹åº”ä½ç½®
- æ’­æ”¾å™¨æ¶æ„å°½é‡å¤ç”¨ç°æœ‰ local player / radio player çš„ç»„ä»¶

ä¸åšï¼ˆv42ï¼‰ï¼š

- ä¸åš language-tutor Agent é¢æ¿ï¼ˆv43ï¼‰
- ä¸åš TTS åŒè¯­å¬åŠ›ç”Ÿæˆï¼ˆv43ï¼‰
- ä¸åšæ–‡ä»¶ç±»å‹æ„ŸçŸ¥æ¸²æŸ“å™¨æ¶æ„ï¼ˆè¿‡åº¦è®¾è®¡ï¼Œä¸éœ€è¦ï¼‰
- ä¸åšå®æ—¶å­—å¹•ï¼ˆv45+ï¼‰

## å…¥å£

é•¿æŒ‰å½•éŸ³ session ç›®å½•ï¼ŒBottomSheet èœå•æ–°å¢é€‰é¡¹ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  rec_20260220_160057      â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  ğŸ“ è½¬å½•                  â”‚  â† v40
â”‚  ğŸŒ è½¬å½•+ç¿»è¯‘             â”‚  â† v41
â”‚  ğŸ§ åŒè¯­æ’­æ”¾              â”‚  â† v42 æ–°å¢
â”‚  âŒ å–æ¶ˆ                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

å‰ç½®æ¡ä»¶ï¼š
- å¦‚æœ session å†…æ²¡æœ‰ ogg æ–‡ä»¶ï¼Œç°æ˜¾å¹¶æç¤º"æ— å½•éŸ³æ–‡ä»¶"
- å¦‚æœæ²¡æœ‰ translation.jsonï¼Œä»å¯æ’­æ”¾ï¼Œå­—å¹•åŒºåŸŸæ˜¾ç¤º transcriptï¼ˆçº¯åŸæ–‡ï¼‰
- å¦‚æœè¿ transcript.json éƒ½æ²¡æœ‰ï¼Œä»å¯æ’­æ”¾ï¼Œå­—å¹•åŒºåŸŸæ˜¾ç¤º"æš‚æ— å­—å¹•"

## æ’­æ”¾å™¨ UI è®¾è®¡

å…¨å±ç«–å±å¸ƒå±€ï¼Œä»ä¸Šåˆ°ä¸‹åˆ†ä¸‰ä¸ªåŒºåŸŸï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  â—€ è¿”å›          åŒè¯­æ’­æ”¾         âš™ è®¾ç½® â”‚  â† é¡¶æ 
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚  [åŸæ–‡]  [è¯‘æ–‡]  [åŒè¯­]                  â”‚  â† æ˜¾ç¤ºæ¨¡å¼ tab
â”‚                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚                                 â”‚    â”‚
â”‚  â”‚  00:00  åœ°å¸¦å±•å¼€å†›äº‹è¡ŒåŠ¨çš„æœ€åˆ    â”‚    â”‚
â”‚  â”‚         åäº”ä¸ªæœˆå†…ï¼Œè¶…è¿‡ä¸ƒç‚¹äº”    â”‚    â”‚
â”‚  â”‚         ä¸‡åå·´å‹’æ–¯å¦äººæ­»äºæš´åŠ›   â”‚    â”‚
â”‚  â”‚         åŒåœ°åŸŸã§è»äº‹ä½œæˆ¦ãŒé–‹å§‹    â”‚    â”‚
â”‚  â”‚         ã•ã‚Œã¦ã‹ã‚‰æœ€åˆã®15ã‹æœˆ    â”‚    â”‚
â”‚  â”‚         ã®é–“ã«...               â”‚    â”‚
â”‚  â”‚                                 â”‚    â”‚
â”‚  â”‚â— 00:13  è¿™é¡¹ç ”ç©¶çš„ä¸»è¦ä½œè€…æ˜¯ä¼¦   â”‚    â”‚  â† å½“å‰æ’­æ”¾å¥é«˜äº®
â”‚  â”‚         æ•¦å¤§å­¦çš‡å®¶éœæ´›ç»´å­¦é™¢...   â”‚    â”‚
â”‚  â”‚         ã“ã®ç ”ç©¶ã®ä¸»ãªè‘—è€…ã¯...   â”‚    â”‚
â”‚  â”‚                                 â”‚    â”‚
â”‚  â”‚  00:25  ç ”ç©¶äººå‘˜è¡¨ç¤ºï¼Œè¿™æ˜¯é¦–ä¸ª   â”‚    â”‚
â”‚  â”‚         ä¸ä¾èµ–åŠ æ²™åœ°å¸¦å«ç”Ÿéƒ¨é—¨   â”‚    â”‚
â”‚  â”‚         è®°å½•...                 â”‚    â”‚
â”‚  â”‚         ç ”ç©¶è€…ã‚‰ã¯ã€ã“ã‚Œã¯...    â”‚    â”‚
â”‚  â”‚                                 â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜    â”‚
â”‚                                         â”‚  â† å­—å¹•åŒºï¼ˆLazyColumnï¼Œå¯æ»šåŠ¨ï¼‰
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                         â”‚
â”‚         âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿âˆ¿             â”‚  â† æ³¢çº¹åŠ¨ç”»ï¼ˆæ’­æ”¾æ—¶æ˜¾ç¤ºï¼‰
â”‚                                         â”‚
â”‚     chunk 1 / 6          01:23 / 10:00  â”‚  â† chunk è¿›åº¦ + æ—¶é—´
â”‚     â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”  â”‚  â† æ€»è¿›åº¦æ¡ï¼ˆè·¨ chunkï¼‰
â”‚                                         â”‚
â”‚         â®   0.75x   â–¶ï¸   1.0x   â­      â”‚  â† æ’­æ”¾æ§åˆ¶
â”‚                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### å­—å¹•åŒºåŸŸ

- åŒè¯­æ¨¡å¼ï¼šæ¯ä¸ª segment æ˜¾ç¤ºä¸¤è¡Œï¼Œä¸Šé¢åŸæ–‡ï¼Œä¸‹é¢è¯‘æ–‡ï¼Œä¹‹é—´ç”¨è¾ƒå°çš„è¡Œè·åŒºåˆ†
- åŸæ–‡æ¨¡å¼ï¼šåªæ˜¾ç¤º sourceText
- è¯‘æ–‡æ¨¡å¼ï¼šåªæ˜¾ç¤º translatedText
- å½“å‰æ’­æ”¾çš„ segment å·¦ä¾§æœ‰ â— æ ‡è®° + èƒŒæ™¯é«˜äº®è‰²
- æ’­æ”¾æ—¶è‡ªåŠ¨æ»šåŠ¨åˆ°å½“å‰ segmentï¼ˆ`animateScrollToItem`ï¼‰
- ç”¨æˆ·æ‰‹åŠ¨æ»šåŠ¨æ—¶æš‚åœè‡ªåŠ¨æ»šåŠ¨ï¼Œ3 ç§’æ— æ“ä½œåæ¢å¤
- ç‚¹å‡»ä»»æ„ segment â†’ seek åˆ°è¯¥ segment çš„ startMs

### æ’­æ”¾æ§åˆ¶åŒºåŸŸ

- æ³¢çº¹åŠ¨ç”»ï¼šç®€å•çš„æ­£å¼¦æ³¢åŠ¨ç”»ï¼Œæ’­æ”¾æ—¶æ˜¾ç¤ºï¼Œæš‚åœæ—¶é™æ­¢ã€‚ç”¨ Canvas + `drawPath` å®ç°ï¼Œä¸éœ€è¦çœŸå®éŸ³é¢‘é¢‘è°±æ•°æ®
- è¿›åº¦æ¡ï¼šæ˜¾ç¤ºæ•´ä¸ª session çš„æ€»è¿›åº¦ï¼ˆè·¨æ‰€æœ‰ chunkï¼‰ï¼Œæ‹–åŠ¨å¯ seek
- chunk æŒ‡ç¤ºï¼šæ˜¾ç¤ºå½“å‰æ’­æ”¾çš„æ˜¯ç¬¬å‡ ä¸ª chunk / æ€» chunk æ•°
- æ—¶é—´æ˜¾ç¤ºï¼šå½“å‰ä½ç½® / æ€»æ—¶é•¿
- æ’­æ”¾/æš‚åœæŒ‰é’®
- ä¸Šä¸€å¥ / ä¸‹ä¸€å¥æŒ‰é’®ï¼ˆâ® â­ï¼‰ï¼šè·³åˆ°å‰ä¸€ä¸ª / ä¸‹ä¸€ä¸ª segment çš„ startMs
- å˜é€ŸæŒ‰é’®ï¼šç‚¹å‡»å¾ªç¯åˆ‡æ¢ 0.5x â†’ 0.75x â†’ 1.0x â†’ 1.25x â†’ 1.5x â†’ 2.0x â†’ 0.5x

### è®¾ç½®ï¼ˆâš™ï¼‰

ç‚¹å‡»å³ä¸Šè§’è®¾ç½®å›¾æ ‡ï¼Œå¼¹å‡º BottomSheetï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  æ’­æ”¾è®¾ç½®                 â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  å­—å¹•å­—å·ï¼š[å°] [ä¸­] [å¤§]  â”‚
â”‚  è‡ªåŠ¨æ»šåŠ¨ï¼šâ˜‘              â”‚
â”‚  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ â”‚
â”‚  âŒ å…³é—­                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## éŸ³é¢‘æ’­æ”¾æ¶æ„

å¤ç”¨ç°æœ‰æ’­æ”¾å™¨æ¶æ„ï¼Œæ ¸å¿ƒæ˜¯ä¸€ä¸ª `SessionPlayer`ï¼š

```kotlin
class SessionPlayer(
    private val mediaPlayer: MediaPlayer,  // å¤ç”¨ç°æœ‰ player ç»„ä»¶
) {
    val state: StateFlow<PlayerState>

    data class PlayerState(
        val isPlaying: Boolean,
        val currentChunkIndex: Int,
        val currentPositionMs: Long,       // å½“å‰ chunk å†…çš„ä½ç½®
        val totalPositionMs: Long,         // è·¨ chunk çš„æ€»ä½ç½®
        val totalDurationMs: Long,         // æ‰€æœ‰ chunk çš„æ€»æ—¶é•¿
        val playbackSpeed: Float,
    )

    /** åŠ è½½ session çš„æ‰€æœ‰ chunk ogg æ–‡ä»¶ï¼ˆæŒ‰æ–‡ä»¶åæ’åºï¼‰ */
    fun loadSession(chunkFiles: List<File>)

    /** æ’­æ”¾ / æš‚åœ */
    fun togglePlayPause()

    /** seek åˆ°æ€»è¿›åº¦çš„æŸä¸ªä½ç½®ï¼ˆè‡ªåŠ¨è®¡ç®—å¯¹åº”çš„ chunk + chunk å†…åç§»ï¼‰ */
    fun seekTo(totalPositionMs: Long)

    /** seek åˆ°æŒ‡å®š chunk çš„æŒ‡å®šä½ç½® */
    fun seekToChunk(chunkIndex: Int, positionMs: Long)

    /** è®¾ç½®æ’­æ”¾é€Ÿåº¦ */
    fun setSpeed(speed: Float)

    /** ä¸Šä¸€å¥ / ä¸‹ä¸€å¥ï¼ˆéœ€è¦å¤–éƒ¨ä¼ å…¥ segment æ—¶é—´æˆ³åˆ—è¡¨ï¼‰ */
    fun seekToPreviousSegment(segments: List<SegmentTimestamp>)
    fun seekToNextSegment(segments: List<SegmentTimestamp>)
}
```

chunk è¡”æ¥é€»è¾‘ï¼š
- `loadSession` æ—¶é¢„è®¡ç®—æ¯ä¸ª chunk çš„æ—¶é•¿ï¼Œæ„å»º `chunkDurations: List<Long>`
- æ’­æ”¾åˆ°å½“å‰ chunk æœ«å°¾æ—¶ï¼Œè‡ªåŠ¨åŠ è½½ä¸‹ä¸€ä¸ª chunk ç»§ç»­æ’­æ”¾
- seek æ—¶æ ¹æ® `totalPositionMs` å’Œ `chunkDurations` è®¡ç®—ç›®æ ‡ chunk + chunk å†…åç§»
- æœ€åä¸€ä¸ª chunk æ’­æ”¾å®Œæ¯• â†’ åœæ­¢ï¼ŒçŠ¶æ€å›åˆ°å¼€å¤´

### ä¸ç°æœ‰æ’­æ”¾å™¨çš„å…³ç³»

- ç°æœ‰ local playerï¼šæ’­æ”¾æœ¬åœ°éŸ³ä¹æ–‡ä»¶ï¼Œæœ‰åŸºæœ¬çš„ play/pause/seek èƒ½åŠ›
- ç°æœ‰ radio playerï¼šæ’­æ”¾åœ¨çº¿ç”µå°æµï¼Œæœ‰ streaming æ’­æ”¾èƒ½åŠ›
- `SessionPlayer` å¤ç”¨ local player çš„ `MediaPlayer` å°è£…ï¼ˆä¸å¤ç”¨ radio player çš„ streaming é€»è¾‘ï¼‰ï¼Œåœ¨å…¶ä¸Šå¢åŠ å¤šæ–‡ä»¶é¡ºåºæ’­æ”¾ + å˜é€Ÿèƒ½åŠ›

## å­—å¹•åŒæ­¥é€»è¾‘

```kotlin
class SubtitleSyncEngine(
    private val playerState: StateFlow<PlayerState>,
) {
    /** å½“å‰åº”é«˜äº®çš„ segment index */
    val currentSegmentIndex: StateFlow<Int>

    /**
     * åŠ è½½å­—å¹•æ•°æ®ã€‚
     * segments æŒ‰ chunk åˆ†ç»„ï¼Œæ¯ä¸ª chunk å¯¹åº”ä¸€ä¸ª translation.json çš„ segments åˆ—è¡¨ã€‚
     * æ—¶é—´æˆ³æ˜¯ chunk å†…çš„ç›¸å¯¹æ—¶é—´ï¼ˆstartMs/endMsï¼‰ã€‚
     */
    fun loadSubtitles(chunkSubtitles: List<ChunkSubtitle>)

    data class ChunkSubtitle(
        val chunkIndex: Int,
        val segments: List<SubtitleSegment>,
    )

    data class SubtitleSegment(
        val id: Int,
        val startMs: Long,
        val endMs: Long,
        val sourceText: String,
        val translatedText: String?,
        val emotion: String?,
    )
}
```

åŒæ­¥ç®—æ³•ï¼š
- ç›‘å¬ `playerState` çš„ `currentChunkIndex` + `currentPositionMs`
- åœ¨å½“å‰ chunk çš„ segments åˆ—è¡¨ä¸­äºŒåˆ†æŸ¥æ‰¾ `startMs <= currentPositionMs < endMs` çš„ segment
- æ›´æ–° `currentSegmentIndex`
- å…è®¸ Â±200ms çš„æ¨¡ç³ŠåŒ¹é…ï¼ˆsegment ä¹‹é—´å¯èƒ½æœ‰é—´éš™ï¼‰

## æ³¢çº¹åŠ¨ç”»

ç®€å•çš„è£…é¥°æ€§åŠ¨ç”»ï¼Œä¸éœ€è¦çœŸå®éŸ³é¢‘é¢‘è°±ï¼š

```kotlin
@Composable
fun AudioWaveform(
    isPlaying: Boolean,
    modifier: Modifier = Modifier,
) {
    // 5-7 æ ¹ç«–æ¡ï¼Œæ’­æ”¾æ—¶é«˜åº¦éšæœºæ³¢åŠ¨ï¼ˆç”¨ animateFloatAsStateï¼‰
    // æš‚åœæ—¶æ‰€æœ‰ç«–æ¡å›åˆ°æœ€ä½é«˜åº¦
    // é¢œè‰²è·Ÿéš MaterialTheme.colorScheme.primary
}
```

ç”¨ç«–æ¡æ³¢åŠ¨æ¯”æ­£å¼¦æ³¢æ›´å®¹æ˜“å®ç°ï¼Œè§†è§‰æ•ˆæœä¹Ÿæ›´å¸¸è§ï¼ˆç±»ä¼¼éŸ³ä¹æ’­æ”¾å™¨çš„å‡è¡¡å™¨åŠ¨ç”»ï¼‰ã€‚

## æ•°æ®åŠ è½½æµç¨‹

æ’­æ”¾å™¨é¡µé¢å¯åŠ¨æ—¶ï¼š

```
1. è¯»å– session ç›®å½•ï¼ŒæŒ‰æ–‡ä»¶åæ’åºè·å– chunk_NNN.ogg åˆ—è¡¨
2. è¯»å– translations/ ç›®å½•ä¸‹å¯¹åº”çš„ chunk_NNN.translation.json
   - å¦‚æœæ²¡æœ‰ translationï¼Œfallback è¯» transcripts/ ä¸‹çš„ chunk_NNN.transcript.json
   - å¦‚æœéƒ½æ²¡æœ‰ï¼Œè¯¥ chunk çš„å­—å¹•ä¸ºç©º
3. æ„å»º SessionPlayerï¼ˆä¼ å…¥ ogg æ–‡ä»¶åˆ—è¡¨ï¼‰
4. æ„å»º SubtitleSyncEngineï¼ˆä¼ å…¥å­—å¹•æ•°æ®ï¼‰
5. å¼€å§‹æ’­æ”¾
```

## Acceptanceï¼ˆç¡¬ DoDï¼‰

- å…¥å£ï¼šé•¿æŒ‰å½•éŸ³ session ç›®å½• â†’ "åŒè¯­æ’­æ”¾" â†’ è¿›å…¥æ’­æ”¾å™¨é¡µé¢
- æ’­æ”¾ï¼šé¡ºåºæ’­æ”¾æ‰€æœ‰ chunk oggï¼Œchunk ä¹‹é—´æ— ç¼è¡”æ¥
- å­—å¹•åŒæ­¥ï¼šæ’­æ”¾æ—¶å½“å‰ segment é«˜äº® + è‡ªåŠ¨æ»šåŠ¨ï¼Œè¯¯å·® â‰¤ 500ms
- æ˜¾ç¤ºæ¨¡å¼ï¼šåŸæ–‡ / è¯‘æ–‡ / åŒè¯­ ä¸‰ç§æ¨¡å¼å¯åˆ‡æ¢
- å˜é€Ÿï¼š0.5x / 0.75x / 1.0x / 1.25x / 1.5x / 2.0x å¯åˆ‡æ¢ï¼Œåˆ‡æ¢åæ’­æ”¾é€Ÿåº¦ç«‹å³ç”Ÿæ•ˆ
- ç‚¹å‡»å®šä½ï¼šç‚¹å‡»ä»»æ„å­—å¹•å¥å­ â†’ seek åˆ°å¯¹åº”ä½ç½®å¹¶æ’­æ”¾
- ä¸Šä¸‹å¥ï¼šâ® â­ æŒ‰é’®è·³åˆ°å‰ä¸€å¥ / ä¸‹ä¸€å¥
- è¿›åº¦æ¡ï¼šæ‹–åŠ¨è¿›åº¦æ¡å¯ seekï¼ˆè·¨ chunkï¼‰
- æ³¢çº¹åŠ¨ç”»ï¼šæ’­æ”¾æ—¶æœ‰åŠ¨ç”»ï¼Œæš‚åœæ—¶é™æ­¢
- é™çº§ï¼šæ— ç¿»è¯‘æ—¶æ˜¾ç¤ºåŸæ–‡å­—å¹•ï¼Œæ— å­—å¹•æ—¶æ˜¾ç¤º"æš‚æ— å­—å¹•"ï¼Œä¸å´©æºƒ
- CLIï¼šæ— æ–°å¢ CLIï¼ˆv42 çº¯ UIï¼‰

éªŒè¯å‘½ä»¤ï¼š

- `.\gradlew.bat :app:testDebugUnitTest`
- çœŸæœºï¼šé•¿æŒ‰å½•éŸ³ç›®å½• â†’ åŒè¯­æ’­æ”¾ â†’ æ’­æ”¾ + å­—å¹•åŒæ­¥ + å˜é€Ÿ + ç‚¹å‡»å®šä½

## é”™è¯¯ç é›†åˆ

| error_code | å«ä¹‰ |
|------------|------|
| `SessionNotFound` | session ç›®å½•ä¸å­˜åœ¨ |
| `SessionNoChunks` | session å†…æ—  ogg æ–‡ä»¶ |
| `ChunkPlaybackError` | ogg æ–‡ä»¶æ’­æ”¾å¤±è´¥ï¼ˆæŸå/æ ¼å¼ä¸æ”¯æŒï¼‰ |
| `SubtitleLoadError` | translation/transcript json è§£æå¤±è´¥ï¼ˆä¸é˜»å¡æ’­æ”¾ï¼‰ |

## Filesï¼ˆè§„åˆ’ï¼‰

- æ’­æ”¾å™¨æ ¸å¿ƒï¼š
  - `app/.../player/SessionPlayer.kt`ï¼ˆå¤š chunk é¡ºåºæ’­æ”¾ + å˜é€Ÿï¼‰
  - `app/.../player/SubtitleSyncEngine.kt`ï¼ˆå­—å¹•åŒæ­¥å¼•æ“ï¼‰
- UIï¼š
  - `app/.../ui/bilingual_player/BilingualPlayerScreen.kt`ï¼ˆæ’­æ”¾å™¨ä¸»é¡µé¢ï¼‰
  - `app/.../ui/bilingual_player/BilingualPlayerViewModel.kt`
  - `app/.../ui/bilingual_player/SubtitleList.kt`ï¼ˆå­—å¹•åˆ—è¡¨ç»„ä»¶ï¼‰
  - `app/.../ui/bilingual_player/SegmentRow.kt`ï¼ˆå•è¡Œ segmentï¼‰
  - `app/.../ui/bilingual_player/PlayerControls.kt`ï¼ˆæ’­æ”¾æ§åˆ¶åŒºï¼‰
  - `app/.../ui/bilingual_player/AudioWaveform.kt`ï¼ˆæ³¢çº¹åŠ¨ç”»ï¼‰
  - `app/.../ui/bilingual_player/PlayerSettingsSheet.kt`ï¼ˆè®¾ç½® BottomSheetï¼‰
- é•¿æŒ‰èœå•æ‰©å±•ï¼š
  - ç°æœ‰ BottomSheet å¢åŠ "åŒè¯­æ’­æ”¾"é€‰é¡¹
- Testsï¼š
  - `SessionPlayerTest.kt`ï¼ˆå¤š chunk æ’­æ”¾ã€seekã€å˜é€Ÿã€chunk è¡”æ¥ï¼‰
  - `SubtitleSyncEngineTest.kt`ï¼ˆæ—¶é—´æˆ³åŒ¹é…ã€chunk åˆ‡æ¢ã€è¾¹ç•Œæƒ…å†µï¼‰
  - `BilingualPlayerViewModelTest.kt`ï¼ˆæ•°æ®åŠ è½½ã€æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢ã€é™çº§é€»è¾‘ï¼‰

## Stepsï¼ˆStrict / TDDï¼‰

1. Analysisï¼šç¡®è®¤ç°æœ‰ local player çš„ MediaPlayer å°è£…æ¥å£ï¼Œç¡®å®š SessionPlayer çš„å¤ç”¨ç­–ç•¥ã€‚
2. TDD Redï¼š`SessionPlayer` æµ‹è¯• â€” å¤š chunk åŠ è½½ã€é¡ºåºæ’­æ”¾ã€seekï¼ˆè·¨ chunkï¼‰ã€å˜é€Ÿã€‚
3. TDD Greenï¼šå®ç° `SessionPlayer`ã€‚
4. TDD Redï¼š`SubtitleSyncEngine` æµ‹è¯• â€” æ—¶é—´æˆ³åŒ¹é…ã€chunk åˆ‡æ¢ã€é—´éš™å¤„ç†ã€æ— å­—å¹•é™çº§ã€‚
5. TDD Greenï¼šå®ç° `SubtitleSyncEngine`ã€‚
6. TDD Redï¼š`BilingualPlayerViewModel` æµ‹è¯• â€” æ•°æ®åŠ è½½æµç¨‹ã€æ˜¾ç¤ºæ¨¡å¼åˆ‡æ¢ã€é™çº§é€»è¾‘ã€‚
7. TDD Greenï¼šå®ç° ViewModelã€‚
8. UIï¼š`BilingualPlayerScreen` + `SubtitleList` + `SegmentRow` + `PlayerControls` + `AudioWaveform`ã€‚
9. UIï¼šé•¿æŒ‰èœå•å¢åŠ "åŒè¯­æ’­æ”¾"å…¥å£ã€‚
10. UIï¼š`PlayerSettingsSheet`ï¼ˆå­—å¹•å­—å· + è‡ªåŠ¨æ»šåŠ¨å¼€å…³ï¼‰ã€‚
11. Verifyï¼šUT å…¨ç»¿ï¼ŒçœŸæœºå†’çƒŸæµ‹è¯•ã€‚

## Risks

- chunk è¡”æ¥çš„æ— ç¼æ€§ï¼šMediaPlayer åˆ‡æ¢éŸ³é¢‘æºæ—¶å¯èƒ½æœ‰çŸ­æš‚çš„åŠ è½½å»¶è¿Ÿï¼ˆå‡ ååˆ°å‡ ç™¾æ¯«ç§’ï¼‰ã€‚å¯ä»¥è€ƒè™‘é¢„åŠ è½½ä¸‹ä¸€ä¸ª chunkï¼ˆ`MediaPlayer.prepareAsync`ï¼‰ï¼Œä½† v42 å…ˆåšåŸºæœ¬ç‰ˆï¼Œæœ‰æ˜æ˜¾å¡é¡¿å†ä¼˜åŒ–ã€‚
- å˜é€Ÿæ’­æ”¾å…¼å®¹æ€§ï¼šAndroid `MediaPlayer.setPlaybackParams` ä» API 23 å¼€å§‹æ”¯æŒï¼Œéœ€ç¡®è®¤æœ€ä½ API levelã€‚å¦‚æœç”¨ ExoPlayer åˆ™æ— æ­¤é—®é¢˜ã€‚
- é•¿å½•éŸ³çš„å†…å­˜ï¼š2 å°æ—¶å½•éŸ³å¯èƒ½æœ‰ 12+ ä¸ª chunkï¼Œæ¯ä¸ª chunk çš„å­—å¹•æ•°æ®çº¦å‡ å KBï¼Œæ€»å…±ä¸åˆ° 1MBï¼Œä¸æ˜¯é—®é¢˜ã€‚
- æ³¢çº¹åŠ¨ç”»æ€§èƒ½ï¼šCanvas ç»˜åˆ¶ 5-7 æ ¹ç«–æ¡ + animateFloatï¼Œæ€§èƒ½å¼€é”€å¯å¿½ç•¥ã€‚