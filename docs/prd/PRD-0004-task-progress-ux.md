# PRD-0004：Task/工具调用进度播报（缓解“卡住焦虑”）

## Vision

当主会话或 `Task(agent=...)` 子会话执行时间较长（几十秒～数分钟）时，用户在聊天气泡内能持续看到“正在做什么 + 已用时”的单行状态播报，避免误以为已卡死/无响应。

## Background / Problem

- 目前工具调用/子会话执行期间，聊天气泡经常长时间空白或仅显示最终结果。
- 即使后台在持续进行 `web_*` / `WebSearch` / `WebFetch` 等步骤，用户看不到明确进度，容易中断任务。

## Non-Goals（明确不做）

- 不改变 Agent 的推理/策略，不以“更聪明”作为目标。
- 不承诺百分百准确的“剩余时间”预测（只显示已用时）。
- 不把子会话 `events.jsonl` 全量回放到主对话（避免噪音和上下文污染）。

## Requirements

### REQ-0004-001：气泡内单行进度播报

- **描述**：当一次发送处于 `isSending=true` 时，对应的 Assistant 气泡内显示一行状态文本。
- **约束**：
  - 单行显示（不换行），超长省略。
  - 状态文本会被不断替换（更新），而不是累积打印多行。
- **验收**：
  - 发送后 1s 内可见状态行。
  - 状态行在工具调用/子会话运行期间持续可见。

### REQ-0004-002：已用时计时器（秒/分/小时）

- **描述**：状态行尾部显示已用时：
  - `<60s`：`52s`
  - `>=60s`：`1m 53s`
  - `>=3600s`：`1h 02m 03s`
- **验收**：
  - 即使没有新事件到达，计时也会每秒更新一次（不需要很精准，但肉眼连续增长）。

### REQ-0004-003：事件文案人类友好（覆盖主会话工具）

- **描述**：主会话工具调用（`ToolUse` / `ToolResult` / `RuntimeError`）会映射为简短中文动词短语，例如：
  - `WebSearch` → “搜索：<query>”
  - `WebFetch` → “抓取：<host>”
  - `web_open` → “打开网页：<host>”
  - `Read/Write/Edit` → “读取/写入/编辑文件：<path>”
- **验收**：在一次典型 web 任务中，状态行至少能覆盖“打开/搜索/抓取/等待/快照”等关键动作。

### REQ-0004-004：Task 子会话进度向上冒泡（最小可用）

- **描述**：当主会话调用 `Task(agent=webview|deep-research)` 时，子会话内部发生的关键动作，会以“进度事件”形式向上冒泡到主 UI 的状态行（不要求 100% 覆盖，但要能看到“在动”）。
- **验收**：
  - `Task` 执行期间，状态行能展示至少一种来自子会话的动作（如“子任务：搜索…/打开网页…”）。
  - 子会话结束或失败后，状态行停止更新，并进入最终回复或错误提示。

## UX Notes

- 状态行只用于“降低焦虑”，不需要展示全部细节。
- Tool Trace 面板仍保留作为调试入口，但用户不必打开也能感知进度。

## Risks

- 过多事件会造成噪音：需要节流/合并（例如只显示最近一次动作）。
- 子会话进度冒泡需确保不会影响主会话 token 与行为。

