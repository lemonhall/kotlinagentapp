# PRD-0035：通用录音机（Recorder）

## 概述

在 app 中提供一个通用录音机功能，使用设备麦克风录制音频，录制完成后可选择转录、翻译，并通过 v42 双语播放器回放。

入口完全在 Files 页签内，不新增导航 tab。`recordings/` 目录使用特殊图标标识，长按启动录音，点击进入录音文件管理。

与电台录制（Radio Recording）的区别：
- Radio Recording：录制的是网络电台流（URL → ogg）
- Recorder：录制的是设备麦克风输入（mic → ogg）
- 后续的转录、翻译、双语播放 pipeline 完全复用

## 用户场景

1. 留学生上课，录下教授的日语/英语讲课，课后转录+翻译成中文复习
2. 出国旅行，录下当地人的对话，事后翻译理解
3. 开会录音，转录成文字备忘
4. 语言学习者录下自己的口语练习，转录后对照检查

## 功能需求

### REQ-0035-010：入口与导航

Files 页签根目录下的 `recordings/` 目录：

- 使用特殊图标（🎙 麦克风图标），区别于普通文件夹，让用户一目了然
- 长按 `recordings/` 目录 → 弹出录音功能菜单
- 单击 `recordings/` 目录 → 进入录音文件列表（普通目录浏览行为）

长按菜单：

```
┌──────────────────────────┐
│  🎙 recordings            │
│  ──────────────────────── │
│  ⏺ 开始录音               │
│  ❌ 取消                   │
└──────────────────────────┘
```

与 `radio_recordings/` 的长按行为一致——目录级别的长按触发功能操作，目录内的文件夹长按触发文件级操作。

### REQ-0035-020：录音

- 选择"开始录音"后进入录音页面（全屏）
- 使用设备麦克风录制，格式 ogg（与电台录制一致）
- 录制过程中显示时长 + 音量波形动画
- 支持暂停/继续录制
- 点击停止结束录制
- 录制文件存储在 `.agents/workspace/recordings/rec_{timestamp}_{random}/` 下

### REQ-0035-030：录音文件管理

单击 `recordings/` 进入后，看到的就是一个个录音 session 文件夹：

```
┌─────────────────────────────────────┐
│  ◀ recordings                        │
├─────────────────────────────────────┤
│  📁 会议录音_20260220                │
│     01:23:45 · 85MB · 2月20日 12:58  │
│                                     │
│  📁 英语课第三讲                     │
│     00:45:12 · 42MB · 2月19日 09:00  │
│                                     │
│  📁 旅行对话                         │
│     00:02:30 · 2MB · 2月18日 15:30   │
└─────────────────────────────────────┘
```

这就是 Files 的普通目录浏览，只是每个 session 文件夹根据 `_meta.json` 渲染出标题、时长、大小等摘要信息（复用 radio_recordings 的 session 文件夹渲染逻辑）。

长按某个录音 session 文件夹：

```
┌──────────────────────────┐
│  会议录音_20260220        │
│  ──────────────────────── │
│  ▶ 播放                   │
│  📝 转录                  │  ← 复用 v40
│  🌐 转录+翻译             │  ← 复用 v41
│  🎧 双语播放              │  ← 复用 v42
│  ✏️ 重命名                │
│  🗑 删除                  │
│  ❌ 取消                   │
└──────────────────────────┘
```

与 radio_recordings 下的 session 文件夹长按菜单完全一致，复用同一套菜单逻辑。

### REQ-0035-040：录音设置

录制完成时弹出保存页面：

- 可编辑录音名称
- 可勾选"自动转录+翻译"
- 可选择目标翻译语言
- 保存后如果勾选了自动 pipeline，立即触发

### REQ-0035-050：后台录制

- 录制进行中切到后台不中断（Foreground Service）
- 通知栏显示录制状态，点击回到录音页面
- 复用电台录制的 Foreground Service 机制

## 目录结构

```
.agents/workspace/
  recordings/                          ← 特殊图标（🎙）
    rec_20260220_125800_abc123/
      _meta.json
      chunk_001.ogg
      transcripts/
        chunk_001.transcript.json
      translations/
        chunk_001.translation.json
  radio_recordings/                    ← 特殊图标（📻）
    rec_20260220_142137_f8jxmg/
      ...
```

两个目录结构完全一致，只是根目录名不同。v40/v41/v42 的代码通过 `_meta.json` 的 `source` 字段区分来源，处理逻辑不区分。

### _meta.json

```json
{
  "schema": "kotlin-agent-app/recording-meta@v1",
  "sessionId": "rec_20260220_125800_abc123",
  "source": "microphone",
  "title": "会议录音_20260220",
  "state": "completed",
  "totalChunks": 1,
  "durationMs": 3600000,
  "sampleRate": 48000,
  "bitrate": 128000,
  "createdAt": "2026-02-20T12:58:00Z",
  "pipeline": {
    "targetLanguage": "zh",
    "transcriptState": "completed",
    "translationState": "completed",
    "transcribedChunks": 1,
    "translatedChunks": 1,
    "failedChunks": 0,
    "lastError": null
  }
}
```

### chunk 策略

- 短录音（< 30 分钟）：单个 chunk，不切分
- 长录音（≥ 30 分钟）：每 10 分钟切一个 chunk（与电台录制一致）
- 切分逻辑复用电台录制的 chunk 机制

## Files 页签的特殊目录图标

在 Files 根目录下，以下目录使用特殊图标：

| 目录 | 图标 | 长按行为 |
|------|------|----------|
| `recordings/` | 🎙 麦克风 | 弹出录音菜单（开始录音） |
| `radio_recordings/` | 📻 收音机 | 弹出电台录制菜单（已有） |

其他目录保持普通文件夹图标。特殊图标的判断逻辑基于目录名硬编码，不需要复杂的注册机制。

## 与电台录制的复用关系

| 能力 | 电台录制 | 通用录音 | 复用方式 |
|------|----------|----------|----------|
| 音频采集 | 网络流 → ogg | 麦克风 → ogg | 不同采集源，输出格式一致 |
| chunk 切分 | 复用 | 复用 | 同一套 chunk 管理逻辑 |
| 目录结构 | radio_recordings/ | recordings/ | 结构一致，路径不同 |
| _meta.json | 复用 | 复用 | 同 schema，`source` 字段区分 |
| session 文件夹渲染 | 复用 | 复用 | 同一套摘要渲染逻辑 |
| 长按菜单 | 复用 | 复用 | 同一套菜单（转录/翻译/双语播放） |
| ASR 转录 | 复用 | 复用 | 同一个 pipeline |
| LLM 翻译 | 复用 | 复用 | 同一个 pipeline |
| 双语播放器 | 复用 | 复用 | 同一个播放器 |
| Foreground Service | 复用 | 复用 | 同一套前台服务机制 |

新增工作量：麦克风采集 → ogg 编码 + 录音 UI（录音页面、完成页面）+ `recordings/` 目录特殊图标 + 长按菜单。

## 非功能需求

### 权限

- `RECORD_AUDIO`：录音权限，首次使用时请求
- `FOREGROUND_SERVICE`：后台录制（复用已有）
- `POST_NOTIFICATIONS`：通知栏常驻（Android 13+，复用已有）

### 存储

- 录音文件存储在 app 私有目录，不需要外部存储权限
- 128kbps ogg 约 1MB/分钟，1 小时约 60MB
- 设备存储不足时提示用户

### 电量

- 长时间录制需要 WakeLock（复用电台录制的机制）
- 电量低于 15% 时提示用户

## UI 线框

### Files 根目录

```
┌─────────────────────────────────────┐
│  Files                               │
├─────────────────────────────────────┤
│  🎙 recordings                       │  ← 特殊图标，长按开始录音
│  📻 radio_recordings                 │  ← 特殊图标，长按开始电台录制
│  📁 documents                        │
│  📁 ...                              │
└─────────────────────────────────────┘
```

### 录制中

```
┌─────────────────────────────────────┐
│  ◀ 返回              录音中          │
├─────────────────────────────────────┤
│                                     │
│                                     │
│                                     │
│            01:23:45                  │
│                                     │
│       ▁▃▅▇▅▃▁▃▅▇▅▃▁               │
│                                     │
│                                     │
│                                     │
│                                     │
│                                     │
│         ⏸      ⏹                   │
│                                     │
└─────────────────────────────────────┘
```

### 录制暂停

```
┌─────────────────────────────────────┐
│  ◀ 返回              已暂停          │
├─────────────────────────────────────┤
│                                     │
│                                     │
│                                     │
│            01:23:45                  │
│                                     │
│       ▁▁▁▁▁▁▁▁▁▁▁▁▁               │
│                                     │
│                                     │
│                                     │
│                                     │
│                                     │
│         ▶      ⏹                   │
│                                     │
└─────────────────────────────────────┘
```

### 录制完成

```
┌─────────────────────────────────────┐
│  录制完成                            │
├─────────────────────────────────────┤
│                                     │
│  录音名称：[新录音_20260220_1258  ]   │
│                                     │
│  时长：01:23:45                      │
│  大小：85MB                          │
│  ──────────────────────────────────  │
│  ☑ 自动转录+翻译                     │
│  目标语言：[中文 ▾]                   │
│  ──────────────────────────────────  │
│                                     │
│         [保存]    [丢弃]             │
│                                     │
└─────────────────────────────────────┘
```

## 优先级

- P0：麦克风录音采集 + 录音 UI + 存储为 session 目录 + 长按菜单复用转录/翻译/双语播放
- P1：暂停/继续、录制完成页（命名 + 自动 pipeline）、`recordings/` 特殊图标
- P2：后台录制（Foreground Service）、通知栏、WakeLock
- P3：音频质量设置、分享

## 开放问题

1. 录音文件是否需要支持导出为其他格式（mp3/wav）？—— 暂不做，ogg 够用
2. 是否需要支持外接麦克风？—— Android 系统默认路由到当前活跃音频输入设备，不需要额外处理